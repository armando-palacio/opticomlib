

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>opticomlib.lab &mdash; opticomlib  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/fonts.css" />

  
    <link rel="shortcut icon" href="../../_static/favicon_laser.ico"/>
      <script src="../../_static/jquery.js"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
      <script src="../../_static/doctools.js"></script>
      <script src="../../_static/sphinx_highlight.js"></script>
      <script src="../../_static/clipboard.min.js"></script>
      <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            opticomlib
              <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#usage">Usage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">OptiComLib Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../types.html">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devices.html">Electro-Optical Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ook.html">OOK Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ppm.html">PPM Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lab.html">Laboratory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils.html">Utilities functions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">opticomlib</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">opticomlib.lab</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for opticomlib.lab</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. rubric:: Functions</span>
<span class="sd">.. autosummary::</span>

<span class="sd">   search_inst</span>
<span class="sd">   connect_inst</span>
<span class="sd">   list_serial_ports</span>
<span class="sd">   SYNC                  </span>
<span class="sd">   GET_EYE_v2</span>
<span class="sd">   save_h5</span>
<span class="sd">   load_h5            </span>

<span class="sd">.. rubric:: Classes</span>
<span class="sd">.. autosummary::</span>

<span class="sd">   PPG3204</span>
<span class="sd">   PED4002</span>
<span class="sd">   IDPhotonics         </span>
<span class="sd">   LeCroy_WavExp100H</span>
<span class="sd">   EXFO_FVA60B</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sg</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_kde</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">binary_sequence</span><span class="p">,</span> <span class="n">electrical_signal</span><span class="p">,</span> <span class="n">eye</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">tic</span><span class="p">,</span> <span class="n">toc</span><span class="p">,</span> 
    <span class="n">str2array</span><span class="p">,</span> 
    <span class="n">nearest</span><span class="p">,</span>
    <span class="n">IntegerNumber</span><span class="p">,</span>
    <span class="n">RealNumber</span><span class="p">,</span>
    <span class="n">Iterable</span>
<span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pyvisa</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">visa</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>


<div class="viewcode-block" id="search_inst"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.search_inst">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">search_inst</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;**Intruments search**</span>
<span class="sd">    </span>
<span class="sd">    Search for the available instruments in the system and print the IDs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rm</span> <span class="o">=</span> <span class="n">visa</span><span class="o">.</span><span class="n">ResourceManager</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">rm</span><span class="o">.</span><span class="n">list_resources</span><span class="p">())</span></div>

<div class="viewcode-block" id="connect_inst"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.connect_inst">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">connect_inst</span><span class="p">(</span><span class="n">addr_ID</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;**Instrument connection**</span>
<span class="sd">    Connect to an instrument via VISA.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    addr_ID : :obj:`str`</span>
<span class="sd">        VISA resource of the instrument (e.g. &#39;USB::0x0699::0x3130::9211219::INSTR&#39;).</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    inst : :obj:`visa.Resource`</span>
<span class="sd">        A connection (session) to the instrument.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inst</span> <span class="o">=</span> <span class="n">visa</span><span class="o">.</span><span class="n">ResourceManager</span><span class="p">()</span><span class="o">.</span><span class="n">open_resource</span><span class="p">(</span><span class="n">addr_ID</span><span class="p">)</span>
    <span class="n">inst</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">10000</span> <span class="c1"># timeout in milliseconds</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;*IDN?&#39;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No identification received!!&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inst</span></div>

<div class="viewcode-block" id="list_serial_ports"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.list_serial_ports">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">list_serial_ports</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List available serial ports and print their descriptions.</span>

<span class="sd">    Uses serial.tools.list_ports.comports() to discover serial ports.</span>
<span class="sd">    Prints &quot;Ports not found&quot; when no ports are found, otherwise prints</span>
<span class="sd">    the .description for each discovered port.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">serial.tools.list_ports</span><span class="w"> </span><span class="kn">import</span> <span class="n">comports</span>
    <span class="n">ports</span> <span class="o">=</span> <span class="n">comports</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ports</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ports not found&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">description</span><span class="p">)</span></div>


<div class="viewcode-block" id="SYNC"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.SYNC">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">SYNC</span><span class="p">(</span><span class="n">signal_rx</span><span class="p">:</span> <span class="n">electrical_signal</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
         <span class="n">slots_tx</span><span class="p">:</span> <span class="n">binary_sequence</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
         <span class="n">sps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;**Signal Synchronizer**</span>

<span class="sd">    Synchronizes the received signal with the transmitted signal to determine the starting position in the received signal for further processing. </span>
<span class="sd">    This is done by performing a correlation between the received signal and the transmitted signal and finding the maximum correlation position</span>
<span class="sd">    and shifting the received signal to that position (deleting the samples before the maximum correlation position).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    signal_rx : :obj:`electrical_signal` | :obj:`np.ndarray`</span>
<span class="sd">        The received digital signal (from the oscilloscope or an ADC).</span>
<span class="sd">    slots_tx : :obj:`binary_sequence` | :obj:`np.ndarray`</span>
<span class="sd">        The transmitted slots sequence.</span>
<span class="sd">    sps : :obj:`int`, optional</span>
<span class="sd">        Number of samples per slot of the digitalized signal ``signal_rx``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`tuple` [:obj:`electrical_signal`, :obj:`int`]</span>
<span class="sd">        A tuple containing the synchronized digital signal and the position in the ``signal_rx`` array from which synchronization was performed.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        The ``sps`` must be an integer to perform synchronization.</span>
<span class="sd">    BufferError</span>
<span class="sd">        If the number of received slots have to be greater than the transmitted slots.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If no correlation maximum is found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">tic</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signal_rx</span><span class="p">,</span> <span class="n">electrical_signal</span><span class="p">):</span>
        <span class="n">sps</span> <span class="o">=</span> <span class="n">signal_rx</span><span class="o">.</span><span class="n">sps</span><span class="p">()</span>
        <span class="n">signal_rx</span> <span class="o">=</span> <span class="n">signal_rx</span><span class="o">.</span><span class="n">signal</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signal_rx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;sps&quot; must be provided to perform synchronization.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The &quot;signal_rx&quot; must be of type `electrical_signal` or `np.ndarray`.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slots_tx</span><span class="p">,</span> <span class="n">binary_sequence</span><span class="p">):</span>
        <span class="n">slots_tx</span> <span class="o">=</span> <span class="n">slots_tx</span><span class="o">.</span><span class="n">data</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slots_tx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The &quot;slots_tx&quot; must be of type `binary_sequence` or `np.ndarray`.&#39;</span><span class="p">)</span>

    <span class="n">signal_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">slots_tx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sps</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">signal_rx</span><span class="p">)</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">signal_tx</span><span class="p">):</span> 
        <span class="k">raise</span> <span class="ne">BufferError</span><span class="p">(</span><span class="s1">&#39;The length of the received vector must be greater than the transmitted vector!!&#39;</span><span class="p">)</span>

    <span class="n">l</span> <span class="o">=</span> <span class="n">signal_tx</span><span class="o">.</span><span class="n">size</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">sg</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">signal_rx</span><span class="p">[:</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="p">],</span> <span class="n">signal_tx</span><span class="p">[</span><span class="n">l</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span> <span class="c1"># Correlation of the transmitted signal with the received signal in a window of 2*l (sufficient to find a maximum)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">corr</span><span class="p">):</span> 
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No correlation maximum found!!&#39;</span><span class="p">)</span> <span class="c1"># false positive</span>
    
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>

    <span class="n">signal_sync</span> <span class="o">=</span> <span class="n">electrical_signal</span><span class="p">(</span><span class="n">signal_rx</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="o">-</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="n">i</span><span class="p">)])</span>
    <span class="n">signal_sync</span><span class="o">.</span><span class="n">execution_time</span> <span class="o">=</span> <span class="n">toc</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">signal_sync</span><span class="p">,</span> <span class="n">i</span></div>


<div class="viewcode-block" id="GET_EYE_v2"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.GET_EYE_v2">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">GET_EYE_v2</span><span class="p">(</span>
        <span class="n">sync_signal</span><span class="p">:</span> <span class="n">electrical_signal</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
        <span class="n">slots_tx</span><span class="p">:</span> <span class="n">binary_sequence</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
        <span class="n">nslots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;**Eye diagram parameters v2**</span>

<span class="sd">    Estimate the means and standard deviations of levels 0 and 1 in the ``sync_signal`` </span>
<span class="sd">    by knowing the transmitted sequence ``slots_tx``. It separates the received signal levels</span>
<span class="sd">    corresponding to transmitted level 0 and 1 and estimates the means and standard deviations,</span>
<span class="sd">    different to ``devices.GET_EYE()`` that assume transmitted bits are not known. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sync_signal : electrical_signal</span>
<span class="sd">        Synchronized digital signal in time with the transmitted signal.</span>
<span class="sd">    slots_tx : binary_sequence</span>
<span class="sd">        Transmitted bit sequence.</span>
<span class="sd">    nslots : int, default: 8192</span>
<span class="sd">        Number of slots to use for estimation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary containing the following keys:</span>

<span class="sd">            - ``sps``: Samples per slot of the digital signal.</span>
<span class="sd">            - ``y``: Synchronized digital signal.</span>
<span class="sd">            - ``unos``: Received signal levels corresponding to transmitted level 1.</span>
<span class="sd">            - ``zeros``: Received signal levels corresponding to transmitted level 0.</span>
<span class="sd">            - ``t0``: Time instants for level 0.</span>
<span class="sd">            - ``t1``: Time instants for level 1.</span>
<span class="sd">            - ``i``: Position in the &#39;signal&#39; vector from which synchronization was performed.</span>
<span class="sd">            - ``mu0``: Mean of level 0.</span>
<span class="sd">            - ``mu1``: Mean of level 1.</span>
<span class="sd">            - ``s0``: Standard deviation of level 0.</span>
<span class="sd">            - ``s1``: Standard deviation of level 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tic</span><span class="p">()</span>

    <span class="c1">#########################</span>
    <span class="c1">## Preprocessing input ##</span>
    <span class="c1">#########################</span>
    
    <span class="nb">input</span> <span class="o">=</span> <span class="n">sync_signal</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">electrical_signal</span><span class="p">):</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">electrical_signal</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slots_tx</span><span class="p">,</span> <span class="n">binary_sequence</span><span class="p">):</span>
        <span class="n">slots_tx</span> <span class="o">=</span> <span class="n">binary_sequence</span><span class="p">(</span><span class="n">slots_tx</span><span class="p">)</span>

    <span class="n">eye_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">eye_dict</span><span class="p">[</span><span class="s1">&#39;sps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sps</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">sps</span><span class="p">()</span>
    <span class="n">eye_dict</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">dt</span><span class="p">()</span>

    <span class="c1"># truncate</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sps</span><span class="p">)</span>  <span class="c1"># we obtain the rest %(2*sps)</span>
    <span class="k">if</span> <span class="n">n</span><span class="p">:</span> <span class="c1"># if rest is not zero</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span> <span class="c1"># ignore last &#39;n&#39; samples</span>

    <span class="n">nslots</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">//</span> <span class="n">sps</span><span class="p">),</span> <span class="n">nslots</span><span class="p">)</span> <span class="c1"># determine the minimum between slots of signal and &#39;nslots&#39; parameter</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[:</span> <span class="n">nslots</span> <span class="o">*</span> <span class="n">sps</span><span class="p">]</span> <span class="c1"># truncate signal</span>

    <span class="nb">input</span> <span class="o">=</span> <span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">signal</span> <span class="o">+</span> <span class="nb">input</span><span class="o">.</span><span class="n">noise</span><span class="p">)</span><span class="o">.</span><span class="n">real</span> <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">noise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">input</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">real</span> <span class="c1"># add noise to signal, if there is noise</span>

    <span class="n">eye_dict</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="o">-</span><span class="n">sps</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">eye_dict</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nslots</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="n">sps</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sps</span><span class="p">),</span> <span class="p">)</span>
    
    <span class="c1">###############</span>
    <span class="c1">## Algorithm ##</span>
    <span class="c1">###############</span>

    <span class="n">ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">slots_tx</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">nslots</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sps</span><span class="p">))</span>

    <span class="n">eye_dict</span><span class="p">[</span><span class="s1">&#39;ones&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ones</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="n">ref</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">eye_dict</span><span class="p">[</span><span class="s1">&#39;zeros&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zeros</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="n">ref</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">eye_dict</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">zeros</span><span class="o">.</span><span class="n">size</span><span class="o">//</span><span class="n">sps</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">sps</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">eye_dict</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ones</span><span class="o">.</span><span class="n">size</span><span class="o">//</span><span class="n">sps</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">sps</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="n">eye_dict</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">sps</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">eye_dict</span><span class="p">[</span><span class="s2">&quot;t_left&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
    <span class="n">eye_dict</span><span class="p">[</span><span class="s2">&quot;t_right&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="n">eye_dict</span><span class="p">[</span><span class="s2">&quot;y_left&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">eye_dict</span><span class="p">[</span><span class="s2">&quot;y_right&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">eye_dict</span><span class="p">[</span><span class="s2">&quot;t_dist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_dist</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">eye_dict</span><span class="p">[</span><span class="s2">&quot;t_opt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_opt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">eye_dict</span><span class="p">[</span><span class="s2">&quot;t_span0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_span0</span> <span class="o">=</span> <span class="n">t_opt</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">t_dist</span>
    <span class="n">eye_dict</span><span class="p">[</span><span class="s2">&quot;t_span1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_span1</span> <span class="o">=</span> <span class="n">t_opt</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">t_dist</span>

    <span class="n">ones_</span> <span class="o">=</span> <span class="n">ones</span><span class="p">[(</span><span class="n">t1</span><span class="o">&gt;</span><span class="n">t_span0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t1</span><span class="o">&lt;</span><span class="n">t_span1</span><span class="p">)]</span>
    <span class="n">zeros_</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">[(</span><span class="n">t0</span><span class="o">&gt;</span><span class="n">t_span0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t0</span><span class="o">&lt;</span><span class="n">t_span1</span><span class="p">)]</span>

    <span class="n">eye_dict</span><span class="p">[</span><span class="s1">&#39;mu0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">zeros_</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="n">eye_dict</span><span class="p">[</span><span class="s1">&#39;mu1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ones_</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>

    <span class="n">eye_dict</span><span class="p">[</span><span class="s1">&#39;s0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">zeros_</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="n">eye_dict</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ones_</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>

    <span class="c1"># compute umbral</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mu0</span><span class="p">,</span> <span class="n">mu1</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">zeros_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="n">ones_</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">eye_dict</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">pdf</span><span class="p">)]</span>

    <span class="c1"># We obtain the extinction ratio</span>
    <span class="n">eye_dict</span><span class="p">[</span><span class="s2">&quot;er&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mu1</span> <span class="o">/</span> <span class="n">mu0</span><span class="p">)</span> <span class="k">if</span> <span class="n">mu0</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">if</span> <span class="n">mu0</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># We obtain the eye opening</span>
    <span class="n">eye_dict</span><span class="p">[</span><span class="s2">&quot;eye_h&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu1</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">s1</span> <span class="o">-</span> <span class="n">mu0</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">s0</span>
    
    <span class="n">eye_dict</span><span class="p">[</span><span class="s2">&quot;execution_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">toc</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">eye</span><span class="p">(</span><span class="o">**</span><span class="n">eye_dict</span><span class="p">)</span></div>


<div class="viewcode-block" id="save_h5"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.save_h5">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">save_h5</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">datos</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves measurement data of signals in an HDF5 file.</span>

<span class="sd">    This function creates an HDF5 file that contains the common time vector,</span>
<span class="sd">    wavelengths, signal data matrix and optional metadata</span>
<span class="sd">    from the oscilloscope and experiment setup.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Base name of the file (without extension). &#39;.h5&#39; will be added.</span>
<span class="sd">    **datos : dict</span>
<span class="sd">        Name and value of the parameter to save. For example save_h5(&#39;name&#39;, time=t, wavelength=w)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">datos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span>
                <span class="n">chunks</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="n">datos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># metadata como atributos</span>
        <span class="n">meta_grp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">meta_grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_h5"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.load_h5">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">load_h5</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads all datasets and metadata from an HDF5 file in a generic way.</span>

<span class="sd">    This function reads an HDF5 file and returns a dictionary with all datasets</span>
<span class="sd">    found (arrays loaded into memory) and metadata if they exist.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Base name of the file (without extension). &#39;.h5&#39; will be added.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data : dict</span>
<span class="sd">        Dictionary with dataset names as keys and ndarray values.</span>
<span class="sd">        If a &#39;metadata&#39; group exists, includes a &#39;metadata&#39; key with dict of attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Cargar todos los datasets de nivel superior</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span>  <span class="c1"># copia a memoria</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span>
                <span class="c1"># Cargar metadatos como dict</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">}</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="PPG3204"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">PPG3204</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;**Tektronix Programmable Pattern Generator PPG3204**</span>
<span class="sd">    </span>
<span class="sd">    The `PPG3204 &lt;https://download.tek.com/manual/PPG1600-PPG3000-PPG3200-Pattern-Generator-User-Manual-077109001.pdf&gt;`_ </span>
<span class="sd">    is a Programmable Pattern Generator. It is a 4-channel pattern generator with 32 Gb/s maximum data rate. </span>
<span class="sd">    This class provides a set of methods to control the PPG3204.</span>

<span class="sd">    .. image:: _images/lab/PPG3204.png </span>
<span class="sd">        :width: 80%</span>
<span class="sd">        :align: center</span>

<span class="sd">    The PPG3204 has the following features:</span>
<span class="sd">        </span>
<span class="sd">    .. rubric:: Attributes</span>
<span class="sd">    .. autosummary::</span>

<span class="sd">        ~PPG3204.inst</span>
<span class="sd">        CHANNELS</span>
<span class="sd">        PATT_LEN_MIN</span>
<span class="sd">        PATT_LEN_MAX</span>
<span class="sd">        AMPLITUDE_MIN</span>
<span class="sd">        AMPLITUDE_MAX</span>
<span class="sd">        OFFSET_MIN</span>
<span class="sd">        OFFSET_MAX</span>
<span class="sd">        FREQ_MIN</span>
<span class="sd">        FREQ_MAX</span>
<span class="sd">        PATT_TYPE</span>
<span class="sd">        PRBS_ORDERS</span>
<span class="sd">        MAX_MEMORY_LEN</span>
<span class="sd">        MAX_CHUNK_LEN</span>
<span class="sd">        MIN_SKEW</span>
<span class="sd">        MAX_SKEW</span>
<span class="sd">        </span>
<span class="sd">    .. rubric:: Methods</span>
<span class="sd">    .. autosummary::</span>

<span class="sd">        __init__</span>
<span class="sd">        __call__</span>
<span class="sd">        reset</span>
<span class="sd">        patt_len</span>
<span class="sd">        get_patt_len</span>
<span class="sd">        patt_type</span>
<span class="sd">        get_patt_type</span>
<span class="sd">        prbs</span>
<span class="sd">        get_prbs</span>
<span class="sd">        data</span>
<span class="sd">        get_data</span>
<span class="sd">        bits_shift</span>
<span class="sd">        get_bits_shift</span>
<span class="sd">        output</span>
<span class="sd">        get_output</span>
<span class="sd">        data_rate</span>
<span class="sd">        get_data_rate</span>
<span class="sd">        skew</span>
<span class="sd">        get_skew</span>
<span class="sd">        amplitude</span>
<span class="sd">        get_amplitude</span>
<span class="sd">        offset</span>
<span class="sd">        get_offset</span>
<span class="sd">        setup</span>
<span class="sd">        get_metadata</span>
<span class="sd">        print_setup</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CHANNELS</span> <span class="o">=</span> <span class="mi">4</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Number of channels of the PPG3204, 4 channels.&quot;&quot;&quot;</span>
    <span class="n">PATT_LEN_MIN</span> <span class="o">=</span> <span class="mi">2</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pattern length minimum value, 2 bit.&quot;&quot;&quot;</span>
    <span class="n">PATT_LEN_MAX</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">21</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pattern length maximum value, 2^21 = 2097152 (2M) bits.&quot;&quot;&quot;</span>
    <span class="n">AMPLITUDE_MIN</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Minimum amplitude of the output signal, 0.3 V.&quot;&quot;&quot;</span>
    <span class="n">AMPLITUDE_MAX</span> <span class="o">=</span> <span class="mi">2</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maximum amplitude of the output signal, 2 V.&quot;&quot;&quot;</span>
    <span class="n">OFFSET_MIN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Minimum offset of the output signal, -2 V.&quot;&quot;&quot;</span>
    <span class="n">OFFSET_MAX</span> <span class="o">=</span> <span class="mi">3</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maximum offset of the output signal, 3 V.&quot;&quot;&quot;</span>
    <span class="n">FREQ_MIN</span> <span class="o">=</span> <span class="mf">1.5e9</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Minimum frequency, 1.5 GHz.&quot;&quot;&quot;</span>
    <span class="n">FREQ_MAX</span> <span class="o">=</span> <span class="mf">32e9</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maximum frequency, 32 GHz.&quot;&quot;&quot;</span>
    <span class="n">PATT_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;PRBS&#39;</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mode of the pattern generator, [&#39;DATA&#39;, &#39;PRBS&#39;]&quot;&quot;&quot;</span>
    <span class="n">PRBS_ORDERS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">31</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The order of polynomial generator for PRBS_TYPE, [7,9,11,15,23,31]&quot;&quot;&quot;</span>
    <span class="n">MAX_MEMORY_LEN</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">21</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maximum length of the memory of the PPG3204, 2^21 = 2097152 (2M) for each channel.&quot;&quot;&quot;</span>
    <span class="n">MAX_CHUNK_LEN</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maximum length of the data to send in a single command, 1024 bits.&quot;&quot;&quot;</span>
    <span class="n">MIN_SKEW</span> <span class="o">=</span> <span class="o">-</span><span class="mf">25e-12</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Minimum skew, -25 ps&quot;&quot;&quot;</span>
    <span class="n">MAX_SKEW</span> <span class="o">=</span> <span class="mf">25e-12</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maximum skew, 25 ps&quot;&quot;&quot;</span>

<div class="viewcode-block" id="PPG3204.__init__"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.__init__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr_ID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reset</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialize the PPG3204.</span>
<span class="sd">        </span>
<span class="sd">        If ``addr_ID`` is not passed as argument, methods will print the commands </span>
<span class="sd">        instead of sending them to the PPG. This is useful for debugging. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        addr_ID : :obj:`str`, optional</span>
<span class="sd">            VISA resource of the PPG (e.g. &#39;USB::0x0699::0x3130::9211219::INSTR&#39;). Default is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">addr_ID</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="n">visa</span><span class="o">.</span><span class="n">ResourceManager</span><span class="p">()</span><span class="o">.</span><span class="n">open_resource</span><span class="p">(</span><span class="n">addr_ID</span><span class="p">)</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;A connection (session) to the PPG instrument (if `addr_ID` is provided).&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">10000</span> <span class="c1"># ms</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="s1">&#39;*IDN?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>

        
    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Query the PPG.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">EOFError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid command </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># invalid command</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># when write commands are executed</span>
            <span class="k">return</span> <span class="n">resp</span>  <span class="c1"># when query commands are executed</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[DEBUG] </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;0&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_check_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if channels are in the correct format and return it as array.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="p">(</span><span class="n">IntegerNumber</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`channels` is not in the correct format&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">IntegerNumber</span><span class="p">):</span>
                <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">channels</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">channels</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHANNELS</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">channels</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHANNELS</span><span class="p">:</span>
                <span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHANNELS</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">CHANNELS</span><span class="p">]</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;The channels number is out of the range of the PPG3204. Setting to the limits </span><span class="si">{</span><span class="n">channels</span><span class="si">}</span><span class="s1">.&#39;</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHANNELS</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">channels</span>


<div class="viewcode-block" id="PPG3204.reset"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.reset">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the PPG to its default state.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="s1">&#39;*RST&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="PPG3204.patt_len"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.patt_len">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">patt_len</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set Data Pattern Length (only relevant if type is DATA).&quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MIN</span> <span class="ow">or</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MAX</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern length </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2"> out of range. Clipping.&quot;</span><span class="p">)</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MIN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MAX</span><span class="p">)</span> 
        
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:DIG</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:PATT:LENG </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="PPG3204.get_patt_len"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.get_patt_len">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_patt_len</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current length of pattern for specified channels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:DIG</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:PATT:LENG?&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">])</span></div>


<div class="viewcode-block" id="PPG3204.patt_type"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.patt_type">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">patt_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;PRBS&#39;</span><span class="p">],</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set pattern type (DATA or PRBS).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        type : str</span>
<span class="sd">            &#39;DATA&#39; or &#39;PRBS&#39;.</span>
<span class="sd">        CHs : int or list</span>
<span class="sd">            Channels to configure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_TYPE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;type must be </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PATT_TYPE</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:DIG</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:PATT:TYPE </span><span class="si">{</span><span class="nb">type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="PPG3204.get_patt_type"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.get_patt_type">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_patt_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get patt_type of the PPG3204 for each channels specified, can be &#39;DATA&#39; or &#39;PRBS&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            List of channels to get the patt_type.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        patt_type : :obj:`np.ndarray`</span>
<span class="sd">            Every channel patt_type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:DIG</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:PATT:TYPE?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">])</span></div>
    

<div class="viewcode-block" id="PPG3204.prbs"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.prbs">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">prbs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">31</span><span class="p">],</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the order of polynomial generator for PRBS patt_type.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        order : :obj:`int` or :obj:`Array_Like(int)`</span>
<span class="sd">            order of the polynomial generator. Default ``7``</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            List of channels to set the order.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If ``order`` is not in the correct format.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        **PRBS pattern lengths** Independently selected for each channel.</span>

<span class="sd">        - :math:`2^7-1` bits. Polynomial :math:`= X^7 + X^6 + 1`</span>
<span class="sd">        - :math:`2^9-1` bits. Polynomial :math:`= X^9 + X^5 + 1`</span>
<span class="sd">        - :math:`2^{11}-1` bits. Polynomial :math:`= X^{11} + X^9 + 1`</span>
<span class="sd">        - :math:`2^{15}-1` bits. Polynomial :math:`= X^{15} + X^{14} + 1`</span>
<span class="sd">        - :math:`2^{23}-1` bits. Polynomial :math:`= X^{23} + X^{18} + 1`</span>
<span class="sd">        - :math:`2^{31}-1` bits. Polynomial :math:`= X^{31} + X^{28} + 1`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">order</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PRBS_ORDERS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Order must be one of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PRBS_ORDERS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:DIG</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:PATT:PLEN </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    
<div class="viewcode-block" id="PPG3204.get_prbs"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.get_prbs">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_prbs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the prbs polynomial order for each channel specified</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            List of channels to get the order.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        order : :obj:`np.ndarray`</span>
<span class="sd">            Every channel order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:DIG</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:PATT:PLEN?&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">])</span></div>
    

<div class="viewcode-block" id="PPG3204.data"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.data">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">start_addr</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the data of the pattern.</span>

<span class="sd">        Programs the pattern data memory. Each byte of pattern data is a character (0 or 1)</span>
<span class="sd">        representing one bit of pattern data. The start address can be any bit location from 1 to MAX_MEMORY_LEN. MAX_MEMORY_LEN is :math:`2^{21} = 2097152` (2M) for each channel. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : :obj:`str` or :obj:`Array_Like(int)`</span>
<span class="sd">            Data to set to the specified channels.</span>
<span class="sd">        start_addr : :obj:`int`, optional</span>
<span class="sd">            Start address of the data to set in the pattern memory. The range is from 1 to 2^21. Default ``1``.</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like`, optional</span>
<span class="sd">            Channels to set the data. If ``CHs=None`` data will be fixed in all channels.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If ``data`` is not in the correct format.</span>

<span class="sd">        Warns</span>
<span class="sd">        -----</span>
<span class="sd">        UserWarning</span>
<span class="sd">            If the length of the data is out of the range of the PPG3204.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        In this examples we don&#39;t pass the argument ``addr_ID`` in order to print the commands output. For communication with a device this parameter is requered.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            &gt;&gt;&gt; from opticomlib.lab import PPG3204</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; ppg = PPG3204()</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; ppg.set_data(&#39;000111000111&#39;, CHs=2)</span>
<span class="sd">            :DIG2:PATT:DATA 1,12,#212000111000111</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; ppg.set_data(&#39;000111000111&#39;)</span>
<span class="sd">            :DIG1:PATT:DATA 1,12,#212000111000111</span>
<span class="sd">            :DIG2:PATT:DATA 1,12,#212000111000111</span>
<span class="sd">            :DIG3:PATT:DATA 1,12,#212000111000111</span>
<span class="sd">            :DIG4:PATT:DATA 1,12,#212000111000111</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; ppg.set_data([[1,0,1,0],[0,1,0,1]], CHs=[3,4])</span>
<span class="sd">            :DIG3:PATT:DATA 1,4,#141010</span>
<span class="sd">            :DIG4:PATT:DATA 1,4,#140101</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`data` is not in the correct format&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">str2array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">data</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`data` string must only contain 0 and 1 characters&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MAX</span><span class="o">-</span><span class="n">start_addr</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;The length of the data is greater than the maximum memory length minus the start address. Setting to the nearest value.&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MAX</span><span class="o">-</span><span class="n">start_addr</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Calculate chunks (Manual page 34 says max bit count per command is 1024)</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CHUNK_LEN</span><span class="p">:</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MAX_CHUNK_LEN</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CHUNK_LEN</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">current_addr</span> <span class="o">=</span> <span class="n">start_addr</span>
            
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
                <span class="n">n_bits</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">size</span>
                <span class="c1"># Create IEEE-488.2 block header: #&lt;num_digits&gt;&lt;n_bytes&gt;&lt;data&gt;</span>
                <span class="c1"># But PED manual page 34 example uses ASCII chars 0/1: </span>
                <span class="c1"># :SENS1:PATT:DATA 1,16,#2160100...</span>
                
                <span class="c1"># Data string &quot;01010...&quot;</span>
                <span class="n">data_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
                
                <span class="n">length_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_bits</span><span class="p">)</span>
                <span class="n">num_digits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">length_str</span><span class="p">)</span>
                
                <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;:DIG</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:PATT:DATA </span><span class="si">{</span><span class="n">current_addr</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">n_bits</span><span class="si">}</span><span class="s1">,#</span><span class="si">{</span><span class="n">num_digits</span><span class="si">}{</span><span class="n">length_str</span><span class="si">}{</span><span class="n">data_str</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                <span class="n">current_addr</span> <span class="o">+=</span> <span class="n">n_bits</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="PPG3204.get_data"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.get_data">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_addr</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the data of the pattern for each specified channel </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        size : :obj:`int`</span>
<span class="sd">            Size of the data to get from the pattern memory.</span>
<span class="sd">        start_addr : :obj:`int`, optional</span>
<span class="sd">            Start address of the data to get from the pattern memory. The range is from 1 to 2^21. Default is 1.</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            List of channels to get the data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data : :obj:`np.ndarray`, shape (n_channels, n_bits)</span>
<span class="sd">            Data of the pattern for each channel.</span>

<span class="sd">        Warns</span>
<span class="sd">        -----</span>
<span class="sd">        UserWarning</span>
<span class="sd">            If the start address or the size is out of the range of the PPG3204.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If ``start_addr`` or ``size`` are not integers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">start_addr</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">start_addr</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MAX</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;`start_addr` must been between 1 and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MAX</span><span class="si">}</span><span class="s1">. Setting to the nearest value.&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">start_addr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">start_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MAX</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MAX</span> <span class="o">-</span> <span class="n">start_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;`length` must been between 1 and (MAX_MEMORY_LEN - start_addr+1)=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MAX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">. Setting to the nearest value.&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MAX</span> <span class="o">-</span> <span class="n">start_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">data_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">current_addr</span> <span class="o">=</span> <span class="n">start_addr</span>
            <span class="n">data_chunks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="n">length</span>
            <span class="k">while</span> <span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CHUNK_LEN</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:DIG</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:PATTERN:DATA? </span><span class="si">{</span><span class="n">current_addr</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="c1"># Response format: #&lt;k&gt;&lt;n&gt;&lt;data&gt;</span>

                <span class="k">if</span> <span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;&#39;</span>
                <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">str2array</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="n">data_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">current_addr</span> <span class="o">+=</span> <span class="n">n</span>
                <span class="n">remaining</span> <span class="o">-=</span> <span class="n">n</span>
            <span class="n">data_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">data_chunks</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_out</span><span class="p">)</span></div>


<div class="viewcode-block" id="PPG3204.bits_shift"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.bits_shift">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">bits_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bsh</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Set the bits shift of the pattern</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bsh : :obj:`int` or :obj:`Array_Like(int)`</span>
<span class="sd">            Bits shift to set to the specify channels.</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            Channels to set the bits shift. If ``CHs=None`` bits shift will be fixed in all channels.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If ``bsh`` is not in the correct format.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        **Pattern shift** advance or delay. This is equivalent to unlimited shifting since this range allow shifting the longest pattern to any position. </span>
<span class="sd">            - **Range**: :math:`\pm(2^{30}-1)`</span>
<span class="sd">            - **Resolution**: 1 bit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bsh</span><span class="p">,</span> <span class="p">(</span><span class="n">IntegerNumber</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`bsh` is not in the correct format&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:DIG</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:PATT:BSH </span><span class="si">{</span><span class="n">bsh</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="PPG3204.get_bits_shift"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.get_bits_shift">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_bits_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the bits shift of the pattern for each specified channel</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            List of channels to get the bits shift.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bsh : :obj:`np.ndarray`</span>
<span class="sd">            Every channel bits shift.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:DIG</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:PATT:BSH?&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">])</span></div>


<div class="viewcode-block" id="PPG3204.output"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.output">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">0</span> <span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ON&#39;</span><span class="p">,</span> <span class="s1">&#39;OFF&#39;</span><span class="p">],</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable or disable the output of the channels</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        state : :obj:`int` {0, 1} or :obj:`str` {&#39;ON&#39;, &#39;OFF&#39;}</span>
<span class="sd">            State to set for the channels (&#39;ON&#39; to enable, &#39;OFF&#39; to disable).</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            Channels to set the output state. If ``CHs=None`` all channels will be affected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">IntegerNumber</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;ON&#39;</span> <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;OFF&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:OUTP</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">state</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PPG3204.get_output"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.get_output">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the output state of the channels</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            Channels to get the output state. If ``CHs=None`` all channels will be queried.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        state : :obj:`np.ndarray`</span>
<span class="sd">            Every channel output state (&#39;ON&#39; or &#39;OFF&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:OUTP</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">])</span></div>


<div class="viewcode-block" id="PPG3204.data_rate"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.data_rate">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">data_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Set the bit rate of the pattern</span>

<span class="sd">        - *Range*: 1.5 GHz to 32 GHz</span>
<span class="sd">        - *Resolution*: 10 kb/s</span>
<span class="sd">        - *Accuracy*: :math:`\pm 5` ppm</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : :obj:`float`</span>
<span class="sd">            Bit Rate of the pattern in bits/s.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FREQ_MIN</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FREQ_MAX</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FREQ_MIN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FREQ_MAX</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;The frequency is out of the range of the PPG3204. Setting to the limits </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> Hz.&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:FREQ </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.5e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    

<div class="viewcode-block" id="PPG3204.get_data_rate"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.get_data_rate">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_data_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the frequency of the pattern.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        freq: :obj:`float`</span>
<span class="sd">            Bit Rate of the pattern in bits/s.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="s1">&#39;:FREQ?&#39;</span><span class="p">))</span></div>
    

<div class="viewcode-block" id="PPG3204.skew"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.skew">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">skew</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skew</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the skew of the channels</span>
<span class="sd">        </span>
<span class="sd">        The channel skew is the timing of the data output. </span>

<span class="sd">        - *Range*: -25 to 25 ps</span>
<span class="sd">        - *Resolution*: 0.1 ps</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        skew : :obj:`float` or :obj:`Array_Like(float)`</span>
<span class="sd">            Skew to set to the specify channels</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            Channels to set the skew. If ``CHs=None`` skew will be fixed in all channels.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If ``skew`` is not in the correct format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">skew</span><span class="p">,</span> <span class="p">(</span><span class="n">RealNumber</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`skew` is not in the correct format&#39;</span><span class="p">)</span>
        

        <span class="k">if</span> <span class="n">skew</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIN_SKEW</span> <span class="ow">or</span> <span class="n">skew</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_SKEW</span><span class="p">:</span>
            <span class="n">skew</span> <span class="o">=</span> <span class="n">skew</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MIN_SKEW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_SKEW</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;The skew is out of the range of the PPG3204. Setting to the limits </span><span class="si">{</span><span class="n">skew</span><span class="si">}</span><span class="s1">.&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SKEW</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">skew</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="PPG3204.get_skew"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.get_skew">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_skew</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the skew of the channels</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            List of channels to get the skew.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        skew : :obj:`np.ndarray`</span>
<span class="sd">            Every channel skew.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SKEW</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">?&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">])</span></div>


<div class="viewcode-block" id="PPG3204.amplitude"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.amplitude">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">amplitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the peak-to-peak output voltage (in mV).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : :obj:`float` or :obj:`Array_Like`</span>
<span class="sd">            Amplitude to set to the specify channels</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like`, optional</span>
<span class="sd">            Channels to set the amplitude. If ``CHs=None`` amplitude will be fixed in all channels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">RealNumber</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`value` is not in the correct format&#39;</span><span class="p">)</span>
        
        <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-3</span>

        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">AMPLITUDE_MIN</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">AMPLITUDE_MAX</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AMPLITUDE_MIN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AMPLITUDE_MAX</span><span class="p">)</span> 
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;The amplitude is out of the range of the PPG3204. Setting to the limits </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">.&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:VOLT</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:POS </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">v&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="PPG3204.get_amplitude"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.get_amplitude">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_amplitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the peak-to-peak output voltage (in mV).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            List of channels to get the amplitude.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Vout : :obj:`np.ndarray`</span>
<span class="sd">            Every channel output voltage.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:VOLT</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:POS?&#39;</span><span class="p">))</span><span class="o">*</span><span class="mf">1e3</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">])</span></div>


<div class="viewcode-block" id="PPG3204.offset"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.offset">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set offset voltage (in mV)</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : :obj:`float` or :obj:`Array_Like(float)`</span>
<span class="sd">            Offset to set to the specify channels</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            Channels to set the offset. If ``CHs=None`` offset will be fixed in all channels.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If ``value`` is not in the correct format.</span>

<span class="sd">        Warns</span>
<span class="sd">        -----</span>
<span class="sd">        UserWarning</span>
<span class="sd">            If the offset is out of the range of the PPG3204.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        </span>
<span class="sd">        **Offset adjust** relative to nominal position. </span>
<span class="sd">            - **Range**: -2000 to 3000 mV</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">RealNumber</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`value` is not in the correct format&#39;</span><span class="p">)</span>
        
        <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-3</span>
        
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">OFFSET_MIN</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">OFFSET_MAX</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OFFSET_MIN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OFFSET_MAX</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;The offset is out of the range of the PPG3204. Setting to the limits </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">.&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:VOLT</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:NEG:OFFS </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">v&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:VOLT</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:POS:OFFS </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">v&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="PPG3204.get_offset"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.get_offset">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the offset voltage (in mV) </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            List of channels to get the offset.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        offset : :obj:`np.ndarray`</span>
<span class="sd">            Every channel offset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:VOLT</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:OFFS?&#39;</span><span class="p">))</span><span class="o">*</span><span class="mf">1e3</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">])</span></div>


<div class="viewcode-block" id="PPG3204.__call__"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
               <span class="n">data_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
               <span class="n">patt_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
               <span class="n">amplitude</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">bsh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
               <span class="n">skew</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">patt_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;PRBS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
               <span class="n">prbs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
               <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">output</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ON&#39;</span><span class="p">,</span> <span class="s1">&#39;OFF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Configure the PPG3204 with the specified parameters for specified channels.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_rate : :obj:`float`, optional</span>
<span class="sd">            Frequency of the pattern in Hz. The range is from 1.5 GHz to 32 GHz.</span>
<span class="sd">        patt_len : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            Pattern length for every channel specified in ``CHs``.</span>
<span class="sd">        amplitude : :obj:`float` or :obj:`Array_Like(float)`, optional</span>
<span class="sd">            Amplitude to set to the specify channels</span>
<span class="sd">        offset : :obj:`float` or :obj:`Array_Like(float)`, optional</span>
<span class="sd">            Offset to set to the specify channels</span>
<span class="sd">        bsh : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            Bits shift to set to the specify channels</span>
<span class="sd">        skew : :obj:`float` or :obj:`Array_Like(float)`, optional</span>
<span class="sd">            Skew to set to the specify channels</span>
<span class="sd">        patt_type : :obj:`str`, optional</span>
<span class="sd">            Work patt_type of the PPG, ``&quot;DATA&quot;`` or ```&quot;PRBS&quot;``. Default ``&quot;PRBS&quot;``</span>
<span class="sd">        prbs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            order of the polynomial generator. If ``patt_type=&#39;PRBS&#39;``.</span>
<span class="sd">        data : :obj:`np.ndarray` or :obj:`Array_Like(np.ndarray)`, optional</span>
<span class="sd">            Data to set to the specify channels. If ``patt_type=&#39;DATA&#39;``.</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            Channels to set the configuration.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        In this examples we don&#39;t pass the argument ``addr_ID`` in order to print the commands output. For communication with a device this parameter is required.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            &gt;&gt;&gt; from opticomlib.lab import PPG3204</span>
<span class="sd">            &gt;&gt;&gt; </span>
<span class="sd">            &gt;&gt;&gt; ppg = PPG3204()</span>
<span class="sd">            &gt;&gt;&gt; ppg(data_rate=10e9, patt_len=1000, amplitude=1.5, offset=0.5, bsh=10, skew=0.5e-12, patt_type=&#39;PRBS&#39;, prbs=7, CHs=2)</span>
<span class="sd">            :FREQ 1.0e+10</span>
<span class="sd">            :DIG2:PATT:LENG 1000</span>
<span class="sd">            :VOLT2:POS 1.5v</span>
<span class="sd">            :VOLT2:POS:OFFS 0.5v</span>
<span class="sd">            :DIG2:PATT:BSH 10</span>
<span class="sd">            :SKEW2 5e-13</span>
<span class="sd">            :DIG2:PATT:TYPE PRBS</span>
<span class="sd">            :DIG2:PATT:PLEN 7</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data_rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_rate</span><span class="p">(</span><span class="n">data_rate</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">patt_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patt_len</span><span class="p">(</span><span class="n">patt_len</span><span class="p">,</span> <span class="n">CHs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">amplitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">amplitude</span><span class="p">(</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">CHs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">CHs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bsh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bits_shift</span><span class="p">(</span><span class="n">bsh</span><span class="p">,</span> <span class="n">CHs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">skew</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="n">skew</span><span class="p">,</span> <span class="n">CHs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">patt_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patt_type</span><span class="p">(</span><span class="n">patt_type</span><span class="p">,</span> <span class="n">CHs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prbs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">patt_type</span> <span class="o">==</span> <span class="s1">&#39;PRBS&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prbs</span><span class="p">(</span><span class="n">prbs</span><span class="p">,</span> <span class="n">CHs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">patt_type</span> <span class="o">==</span> <span class="s1">&#39;DATA&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">start_addr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">CHs</span><span class="o">=</span><span class="n">CHs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">CHs</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    
<div class="viewcode-block" id="PPG3204.get_metadata"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.get_metadata">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve a summary of the current PPG configuration for the specified channel as a dictionary.&quot;&quot;&quot;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;PATT_TYPE&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_patt_type</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;PATT_LEN&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_patt_len</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;PRBS&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prbs</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_amplitude</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;OFFSET&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_offset</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;OUTPUT&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;DATA_RATE&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_rate</span><span class="p">(),</span>
            <span class="s1">&#39;SKEW&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_skew</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;BITS_SHIFT&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bits_shift</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">metadata</span></div>
    
<div class="viewcode-block" id="PPG3204.print_setup"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.print_setup">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Print the current configuration of the PPG3204 for a specified channel.&quot;&quot;&quot;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== PPG3204 SETUP ===&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">1</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">11</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======================&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    
<div class="viewcode-block" id="PPG3204.setup"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PPG3204.setup">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="n">data_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
            <span class="n">patt_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;PRBS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
            <span class="n">patt_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
            <span class="n">amplitude</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">bsh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
            <span class="n">skew</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">prbs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
            <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">output</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ON&#39;</span><span class="p">,</span> <span class="s1">&#39;OFF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Configure the PPG3204 with the specified parameters for specified channels.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_rate : :obj:`float`, optional</span>
<span class="sd">            Frequency of the pattern in Hz. The range is from 1.5 GHz to 32 GHz.</span>
<span class="sd">        patt_len : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            Pattern length for every channel specified in ``CHs``.</span>
<span class="sd">        amplitude : :obj:`float` or :obj:`Array_Like(float)`, optional</span>
<span class="sd">            Amplitude to set to the specify channels</span>
<span class="sd">        offset : :obj:`float` or :obj:`Array_Like(float)`, optional</span>
<span class="sd">            Offset to set to the specify channels</span>
<span class="sd">        bsh : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            Bits shift to set to the specify channels</span>
<span class="sd">        skew : :obj:`float` or :obj:`Array_Like(float)`, optional</span>
<span class="sd">            Skew to set to the specify channels</span>
<span class="sd">        patt_type : :obj:`str`, optional</span>
<span class="sd">            Work patt_type of the PPG.</span>
<span class="sd">        prbs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            order of the polynomial generator. If ``patt_type=&#39;PRBS&#39;``.</span>
<span class="sd">        data : :obj:`np.ndarray` or :obj:`Array_Like(np.ndarray)`, optional</span>
<span class="sd">            Data to set to the specify channels. If ``patt_type=&#39;DATA&#39;``.</span>
<span class="sd">        CHs : :obj:`int` or :obj:`Array_Like(int)`, optional</span>
<span class="sd">            Channels to set the configuration.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        In this examples we don&#39;t pass the argument ``addr_ID`` in order to print the commands output. For communication with a device this parameter is required.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            &gt;&gt;&gt; from opticomlib.lab import PPG3204</span>
<span class="sd">            &gt;&gt;&gt; </span>
<span class="sd">            &gt;&gt;&gt; ppg = PPG3204()</span>
<span class="sd">            &gt;&gt;&gt; ppg(data_rate=10e9, patt_len=1000, amplitude=1.5, offset=0.5, bsh=10, skew=0.5e-12, patt_type=&#39;PRBS&#39;, prbs=7, CHs=2)</span>
<span class="sd">            :FREQ 1.0e+10</span>
<span class="sd">            :DIG2:PATT:LENG 1000</span>
<span class="sd">            :VOLT2:POS 1.5v</span>
<span class="sd">            :VOLT2:POS:OFFS 0.5v</span>
<span class="sd">            :DIG2:PATT:BSH 10</span>
<span class="sd">            :SKEW2 5e-13</span>
<span class="sd">            :DIG2:PATT:TYPE PRBS</span>
<span class="sd">            :DIG2:PATT:PLEN 7</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">data_rate</span><span class="p">,</span> <span class="n">patt_len</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bsh</span><span class="p">,</span> <span class="n">skew</span><span class="p">,</span> <span class="n">patt_type</span><span class="p">,</span> <span class="n">prbs</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">CHs</span><span class="p">)</span></div></div>







<div class="viewcode-block" id="PED4002"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">PED4002</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    **Tektronix PED3200 / PED4000 Series Programmable Error Detector**</span>

<span class="sd">    High-performance programmable error detector (up to 32 Gb/s for PED3200, 40 Gb/s for PED4000).</span>
<span class="sd">    This class mirrors the remote programming command set described in the user manual</span>
<span class="sd">    `PED3200-PED4000-Programmable-Error-Detector-User-Manual-077109501.pdf`.</span>

<span class="sd">    .. rubric:: Attributes</span>
<span class="sd">    .. autosummary::</span>

<span class="sd">        ~PED4002.inst</span>
<span class="sd">        CHANNELS</span>
<span class="sd">        PATT_LEN_MIN</span>
<span class="sd">        PATT_LEN_MAX_1CH</span>
<span class="sd">        PATT_LEN_MAX_2CH</span>
<span class="sd">        CLK_DELAY_MIN</span>
<span class="sd">        CLK_DELAY_MAX</span>
<span class="sd">        EYE_THRESH_MIN</span>
<span class="sd">        EYE_THRESH_MAX</span>
<span class="sd">        SYNC_THRESH_MIN</span>
<span class="sd">        SYNC_THRESH_MAX</span>
<span class="sd">        PATT_TYPE</span>
<span class="sd">        PRBS_ORDERS</span>
<span class="sd">        MAX_CHUNK_LEN</span>

<span class="sd">    .. rubric:: Main methods</span>
<span class="sd">    .. autosummary::</span>

<span class="sd">        __init__</span>
<span class="sd">        __call__</span>
<span class="sd">        reset</span>
<span class="sd">        patt_len</span>
<span class="sd">        get_patt_len</span>
<span class="sd">        patt_type</span>
<span class="sd">        get_patt_type</span>
<span class="sd">        prbs</span>
<span class="sd">        get_prbs</span>
<span class="sd">        data</span>
<span class="sd">        get_data</span>
<span class="sd">        sync</span>
<span class="sd">        is_sync</span>
<span class="sd">        sync_threshold</span>
<span class="sd">        get_sync_threshold</span>
<span class="sd">        center_offset</span>
<span class="sd">        offset</span>
<span class="sd">        get_offset</span>
<span class="sd">        get_voltage_edges</span>
<span class="sd">        center_delay</span>
<span class="sd">        delay</span>
<span class="sd">        get_delay</span>
<span class="sd">        get_time_edges</span>
<span class="sd">        eye_threshold</span>
<span class="sd">        get_eye_threshold</span>
<span class="sd">        is_running</span>
<span class="sd">        run</span>
<span class="sd">        stop</span>
<span class="sd">        get_ber</span>
<span class="sd">        get_error_count</span>
<span class="sd">        get_bit_count</span>
<span class="sd">        get_frequency</span>
<span class="sd">        setup</span>
<span class="sd">        get_metadata</span>
<span class="sd">        print_setup</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CHANNELS</span> <span class="o">=</span> <span class="mi">2</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maximum number of channels (Model dependent).&quot;&quot;&quot;</span>
    <span class="n">PATT_LEN_MIN</span> <span class="o">=</span> <span class="mi">2</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pattern length minimum value.&quot;&quot;&quot;</span>
    <span class="n">PATT_LEN_MAX_1CH</span> <span class="o">=</span> <span class="mi">4_194_304</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pattern length maximum value for single channel config (4 Mbit).&quot;&quot;&quot;</span>
    <span class="n">PATT_LEN_MAX_2CH</span> <span class="o">=</span> <span class="mi">2_097_152</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pattern length maximum value per channel for 2-ch config (2 Mbit).&quot;&quot;&quot;</span>
    <span class="n">CLK_DELAY_MIN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">50</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Minimum clock delay (-50 ps).&quot;&quot;&quot;</span>
    <span class="n">CLK_DELAY_MAX</span> <span class="o">=</span> <span class="mi">50</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maximum clock delay (+50 ps).&quot;&quot;&quot;</span>
    <span class="n">EYE_THRESH_MIN</span> <span class="o">=</span> <span class="mf">1e-11</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Minimum Eye Edge BER Threshold.&quot;&quot;&quot;</span>
    <span class="n">EYE_THRESH_MAX</span> <span class="o">=</span> <span class="mf">1e-1</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maximum Eye Edge BER Threshold.&quot;&quot;&quot;</span>
    <span class="n">SYNC_THRESH_MIN</span> <span class="o">=</span> <span class="mf">1e-8</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Minimum Synchronization BER Threshold.&quot;&quot;&quot;</span>
    <span class="n">SYNC_THRESH_MAX</span> <span class="o">=</span> <span class="mf">1e-1</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maximum Synchronization BER Threshold.&quot;&quot;&quot;</span>
    <span class="n">PATT_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;PRBS&#39;</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mode of the error detector.&quot;&quot;&quot;</span>
    <span class="n">PRBS_ORDERS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">31</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Supported PRBS polynomial orders.&quot;&quot;&quot;</span>
    <span class="n">MAX_CHUNK_LEN</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maximum length of the data block to write in a single command.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="PED4002.__init__"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.__init__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr_ID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialize the PED.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        addr_ID : :obj:`str`, optional</span>
<span class="sd">            VISA resource of the PED. Default is None (Debug mode).</span>
<span class="sd">        reset : :obj:`bool`, optional</span>
<span class="sd">            If True, reset the instrument to factory defaults upon connection. Default is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">addr_ID</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="n">visa</span><span class="o">.</span><span class="n">ResourceManager</span><span class="p">()</span><span class="o">.</span><span class="n">open_resource</span><span class="p">(</span><span class="n">addr_ID</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">10000</span>  <span class="c1"># ms</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="s1">&#39;*IDN?&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="s1">&#39;*IDN?&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal query/write helper (prints command if no connection).&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">EOFError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid command </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># invalid command</span>
                <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># when write commands are executed</span>
                <span class="k">return</span> <span class="n">resp</span>  <span class="c1"># when query commands are executed</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[DEBUG] </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;0&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error sending command &#39;</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if channels are correct and return as array.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="p">(</span><span class="n">IntegerNumber</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`channels` is not in the correct format&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">IntegerNumber</span><span class="p">):</span>
                <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">channels</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">channels</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHANNELS</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHANNELS</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Channels clipped to limits </span><span class="si">{</span><span class="n">channels</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHANNELS</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">channels</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the SCPI nodes for Data and Clock based on channel.</span>
<span class="sd">        According to Manual Page 18/34:</span>
<span class="sd">        Ch1 Data -&gt; SENSe1, Ch1 Clock -&gt; SENSe2/INPut2</span>
<span class="sd">        Ch2 Data -&gt; SENSe3, Ch2 Clock -&gt; SENSe4/INPut4</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_node</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">clock_node</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data_node</span><span class="p">,</span> <span class="n">clock_node</span>

    <span class="c1"># ==============================================================</span>
    <span class="c1"># Basic instrument control</span>
    <span class="c1"># ==============================================================</span>

<div class="viewcode-block" id="PED4002.reset"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.reset">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the PED to default settings (``*RST``).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="s1">&#39;*RST&#39;</span><span class="p">)</span>
        <span class="c1"># Wait for operation complete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="s1">&#39;*OPC?&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="c1"># ==============================================================</span>
    <span class="c1"># Pattern configuration (same for both data channels)</span>
    <span class="c1"># ==============================================================</span>
    
<div class="viewcode-block" id="PED4002.patt_len"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.patt_len">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">patt_len</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set Data Pattern Length (only relevant if type is DATA).&quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        
        <span class="c1"># Simple limit check (assuming 2CH mode for safety if generic)</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MAX_2CH</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHANNELS</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MAX_1CH</span>

        <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MIN</span> <span class="ow">or</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pattern length </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2"> out of range. Clipping.&quot;</span><span class="p">)</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MIN</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:PATT:LENG </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    
<div class="viewcode-block" id="PED4002.get_patt_len"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.get_patt_len">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_patt_len</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current length of pattern for specified channels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">:PATT:LENG?&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">])</span></div>
    

<div class="viewcode-block" id="PED4002.patt_type"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.patt_type">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">patt_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;PRBS&#39;</span><span class="p">],</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set pattern type (DATA or PRBS).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        type : str</span>
<span class="sd">            &#39;DATA&#39; or &#39;PRBS&#39;.</span>
<span class="sd">        CHs : int or list</span>
<span class="sd">            Channels to configure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_TYPE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;type must be </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PATT_TYPE</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:PATT:TYPE </span><span class="si">{</span><span class="nb">type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    
<div class="viewcode-block" id="PED4002.get_patt_type"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.get_patt_type">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_patt_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current pattern type.&quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:PATT:TYPE?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="PED4002.prbs"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.prbs">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">prbs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">31</span><span class="p">],</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set PRBS Polynomial order (2^N - 1).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        order : int</span>
<span class="sd">            One of [7, 9, 11, 15, 23, 31].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">order</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PRBS_ORDERS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Order must be one of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PRBS_ORDERS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:PATT:PLEN </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="PED4002.get_prbs"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.get_prbs">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_prbs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current PRBS order.&quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">:PATT:PLEN?&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">])</span></div>
    

<div class="viewcode-block" id="PED4002.data"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.data">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">start_addr</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Program the user pattern data.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : str or array</span>
<span class="sd">            The binary data (e.g. &quot;010110&quot;).</span>
<span class="sd">        start_addr : int</span>
<span class="sd">            Memory start address (1-based).</span>
<span class="sd">        CHs : int or list</span>
<span class="sd">            Channels to program.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`data` is not in the correct format&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">str2array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">data</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`data` string must only contain 0 and 1 characters&#39;</span><span class="p">)</span>

        <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MAX_2CH</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHANNELS</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MAX_1CH</span>

        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="o">-</span><span class="n">start_addr</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;The length of the data is greater than the maximum memory length minus the start address. Setting to the nearest value.&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">limit</span><span class="o">-</span><span class="n">start_addr</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Calculate chunks (Manual page 34 says max bit count per command is 1024)</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CHUNK_LEN</span><span class="p">:</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MAX_CHUNK_LEN</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CHUNK_LEN</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="n">current_addr</span> <span class="o">=</span> <span class="n">start_addr</span>
            
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
                <span class="n">n_bits</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">size</span>
                <span class="c1"># Create IEEE-488.2 block header: #&lt;num_digits&gt;&lt;n_bytes&gt;&lt;data&gt;</span>
                <span class="c1"># But PED manual page 34 example uses ASCII chars 0/1: </span>
                <span class="c1"># :SENS1:PATT:DATA 1,16,#2160100...</span>
                
                <span class="c1"># Data string &quot;01010...&quot;</span>
                <span class="n">data_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
                
                <span class="n">length_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_bits</span><span class="p">)</span>
                <span class="n">num_digits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">length_str</span><span class="p">)</span>
                
                <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:PATT:DATA </span><span class="si">{</span><span class="n">current_addr</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">n_bits</span><span class="si">}</span><span class="s1">,#</span><span class="si">{</span><span class="n">num_digits</span><span class="si">}{</span><span class="n">length_str</span><span class="si">}{</span><span class="n">data_str</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                <span class="n">current_addr</span> <span class="o">+=</span> <span class="n">n_bits</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="PED4002.get_data"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.get_data">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_addr</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve binary pattern data as numpy bool array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>

        <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MAX_2CH</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHANNELS</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATT_LEN_MAX_1CH</span>

        <span class="k">if</span> <span class="n">start_addr</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">start_addr</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;`start_addr` must been between 1 and </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s1">. Setting to the nearest value.&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">start_addr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">start_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">limit</span> <span class="o">-</span> <span class="n">start_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;`length` must been between 1 and (MAX_MEMORY_LEN - start_addr+1)=</span><span class="si">{</span><span class="n">limit</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">. Setting to the nearest value.&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">limit</span> <span class="o">-</span> <span class="n">start_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">data_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="n">current_addr</span> <span class="o">=</span> <span class="n">start_addr</span>
            <span class="n">data_chunks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="n">length</span>
            <span class="k">while</span> <span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CHUNK_LEN</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENSE</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:PATTERN:DATA? </span><span class="si">{</span><span class="n">current_addr</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="c1"># Response format: #&lt;k&gt;&lt;n&gt;&lt;data&gt;</span>

                <span class="k">if</span> <span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;&#39;</span>
                <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">str2array</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="n">data_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">current_addr</span> <span class="o">+=</span> <span class="n">n</span>
                <span class="n">remaining</span> <span class="o">-=</span> <span class="n">n</span>
            <span class="n">data_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">data_chunks</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_out</span><span class="p">)</span></div>
    
    <span class="c1"># =================================================================</span>
    <span class="c1"># CLOCK &amp; ALIGNMENT SETTINGS</span>
    <span class="c1"># =================================================================</span>

<div class="viewcode-block" id="PED4002.sync"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.sync">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initiate pattern synchronization.&quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:SYNC:EXEC ONCE&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:SYNC:EXEC?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;BUSY&#39;</span><span class="p">:</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sync failed on CH</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">break</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span> <span class="k">if</span> <span class="n">wait</span> <span class="k">else</span> <span class="bp">self</span></div>
                        
    
<div class="viewcode-block" id="PED4002.is_sync"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.is_sync">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the specified channels are synchronized.&quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="n">sync_status</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:SYNC:STAT?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">sync_status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;SYNC&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sync_status</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="PED4002.sync_threshold"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.sync_threshold">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">sync_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ber</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Programs the synchronization BER threshold. This is the maximum BER value for which a synchronization is considered successful. Also, in auto sync mode, the current BER is monitored and compared to this threshold. The threshold may range from 10-1 to 10-8 in decade steps.</span>
<span class="sd">        Synchronization will succeed only if the BER of the system is less than the sync BER threshold.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ber : float</span>
<span class="sd">            BER threshold between 1e-8 and 1e-1.</span>
<span class="sd">        CHs : int or list</span>
<span class="sd">            Channels to configure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ber</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">SYNC_THRESH_MIN</span> <span class="ow">or</span> <span class="n">ber</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">SYNC_THRESH_MAX</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BER threshold </span><span class="si">{</span><span class="n">ber</span><span class="si">}</span><span class="s2"> out of range.&quot;</span><span class="p">)</span>
            <span class="n">ber</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">ber</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SYNC_THRESH_MIN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SYNC_THRESH_MAX</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:SYNC:THR </span><span class="si">{</span><span class="n">ber</span><span class="si">:</span><span class="s1">.1e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    
<div class="viewcode-block" id="PED4002.get_sync_threshold"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.get_sync_threshold">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_sync_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current synchronization BER threshold.&quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="n">bers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:SYNC:THR?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">bers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bers</span><span class="p">)</span></div>
    
    <span class="c1"># ==============================================================</span>
    <span class="c1"># Eye &amp; decision threshold</span>
    <span class="c1"># ==============================================================</span>

<div class="viewcode-block" id="PED4002.center_offset"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.center_offset">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">center_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initiates the center offset process.</span>
<span class="sd">        </span>
<span class="sd">        The center offset process can take a significant amount of time. It uses the EYE EDGE BER THRESHOLD to determine the eye edges during the process. Lower EYE EDGE BER THRESHOLD values take more time, as do data patterns (vs PRBS) and longer data pattern lengths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:EYE:OCENter ONCE&#39;</span><span class="p">)</span> <span class="c1"># begins the center offset process</span>
            <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:EYE:OCENter?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;BUSY&#39;</span><span class="p">:</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sync failed on CH</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="PED4002.offset"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.offset">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set decision threshold offset (in mV). Range -300 mV to +300 mV.</span>
<span class="sd">        </span>
<span class="sd">        Programs the data offset voltage. The default value of 0 is normally good for 50% duty input signals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">300</span> <span class="ow">or</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Offset </span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2"> mV out of range.&quot;</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:EYE:OFFS </span><span class="si">{</span><span class="n">offset</span><span class="o">*</span><span class="mf">1e-3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    
<div class="viewcode-block" id="PED4002.get_offset"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.get_offset">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current decision threshold offset (in mV).&quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:EYE:OFFS?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span><span class="o">*</span><span class="mf">1e3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="PED4002.center_delay"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.center_delay">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">center_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initiates the center clock delay process.</span>
<span class="sd">        </span>
<span class="sd">        The center clock delay process can take a significant amount of time. It uses the EYE EDGE BER THRESHOLD to determine the eye edges during the process. Lower EYE EDGE BER THRESHOLD values take more time, as do data patterns (vs PRBS) and longer data pattern lengths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:EYE:TCENter ONCE&#39;</span><span class="p">)</span> <span class="c1"># begins the center offset process</span>
            <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:EYE:TCENter?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;BUSY&#39;</span><span class="p">:</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sync failed on CH</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    
<div class="viewcode-block" id="PED4002.delay"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.delay">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set Clock to Data delay (in ps).</span>
<span class="sd">        </span>
<span class="sd">        Range: +/- 50 ps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">delay</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLK_DELAY_MIN</span> <span class="ow">or</span> <span class="n">delay</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLK_DELAY_MAX</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Delay </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s2"> out of range.&quot;</span><span class="p">)</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLK_DELAY_MIN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLK_DELAY_MAX</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">c_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="c1"># Uses Input Node (2 or 4)</span>
            <span class="c1"># Manual page 23: :INPut[2|4]:DELay</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:INP</span><span class="si">{</span><span class="n">c_node</span><span class="si">}</span><span class="s1">:DEL </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s1">ps&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    
<div class="viewcode-block" id="PED4002.get_delay"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.get_delay">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current Clock to Data delay (in picoseconds).&quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="n">delays</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">c_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="c1"># Uses Input Node (2 or 4)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:INP</span><span class="si">{</span><span class="n">c_node</span><span class="si">}</span><span class="s1">:DEL?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span><span class="o">*</span><span class="mf">1e12</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">delays</span><span class="p">)</span></div>

<div class="viewcode-block" id="PED4002.get_time_edges"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.get_time_edges">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_time_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Eye Time Edges (in secons).</span>
<span class="sd">        </span>
<span class="sd">        Queries the left or right (time axis) eye edges as determined during the most recent automatic process that sets the horizontal sampling point. This includes the Center Clock Delay and Auto Align processes. If those processes have not been run or failed on the most recent attempt, the return value will be 9.91e37. (NaN)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="n">t_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:EYE:TEDGE? 1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">t_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:EYE:TEDGE? 2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
            <span class="n">t_left</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t_left</span><span class="p">)</span>
            <span class="n">t_right</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t_right</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t_left</span> <span class="o">&gt;</span> <span class="mf">9e37</span><span class="p">:</span>
                <span class="n">t_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="n">t_right</span> <span class="o">&gt;</span> <span class="mf">9e37</span><span class="p">:</span>
                <span class="n">t_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>   

            <span class="n">t_edges</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_left</span><span class="p">,</span> <span class="n">t_right</span><span class="p">)</span>
            <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_edges</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="PED4002.eye_threshold"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.eye_threshold">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">eye_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ber</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set Eye Edge BER Threshold.</span>
<span class="sd">        </span>
<span class="sd">        Programs the eye edge BER threshold. This is the maximum BER value for which an eye edge is considered valid during automatic processes that determine eye edges. The threshold may range from 10-1 to 10-11 in decade steps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ber</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">EYE_THRESH_MIN</span> <span class="ow">or</span> <span class="n">ber</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">EYE_THRESH_MAX</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BER threshold </span><span class="si">{</span><span class="n">ber</span><span class="si">}</span><span class="s2"> out of range.&quot;</span><span class="p">)</span>
            <span class="n">ber</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">ber</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EYE_THRESH_MIN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EYE_THRESH_MAX</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:EYE:THR </span><span class="si">{</span><span class="n">ber</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    
<div class="viewcode-block" id="PED4002.get_eye_threshold"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.get_eye_threshold">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_eye_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current Eye Edge BER Threshold.&quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="n">bers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:EYE:THR?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">bers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bers</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="PED4002.get_voltage_edges"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.get_voltage_edges">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_voltage_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Eye Voltage Edges (in Volts).</span>
<span class="sd">        </span>
<span class="sd">        Queries the upper and lower (voltage axis) eye edges as determined during the most recent automatic process that sets the vertical sampling point. This includes the Center Offset and Auto Align processes. If those processes have not been run or failed on the most recent attempt, the return value will be 9.91e37. (NaN)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="n">v_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:EYE:VEDG? 2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">v_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:EYE:VEDG? 1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            
            <span class="n">v_up</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v_up</span><span class="p">)</span>
            <span class="n">v_down</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v_down</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v_up</span> <span class="o">&gt;</span> <span class="mf">9e37</span><span class="p">:</span>
                <span class="n">v_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="n">v_down</span> <span class="o">&gt;</span> <span class="mf">9e37</span><span class="p">:</span>
                <span class="n">v_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="n">v_edges</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_down</span><span class="p">,</span> <span class="n">v_up</span><span class="p">)</span>
            <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_edges</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span><span class="o">*</span><span class="mf">1e3</span>  <span class="c1"># in mV</span></div>

    <span class="c1"># ==============================================================</span>
    <span class="c1"># Gating</span>
    <span class="c1"># ==============================================================</span>
    
<div class="viewcode-block" id="PED4002.is_running"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.is_running">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if error detection is running (gating enabled).&quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="n">states</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:GATE:STATE?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resp</span> <span class="o">==</span> <span class="s1">&#39;ON&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">states</span><span class="p">)</span></div>

<div class="viewcode-block" id="PED4002.run"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.run">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start error detection (enable gating).&quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sync</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync</span><span class="p">(</span><span class="n">CHs</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Cannot start error detection: synchronization failed on one or more channels.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Error detection already running.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># already running</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:GATE:STATE ON&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    
<div class="viewcode-block" id="PED4002.stop"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.stop">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop error detection (disable gating).&quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Error detection already stopped.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># already stopped</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:GATE:STATE OFF&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="c1"># ==============================================================</span>
    <span class="c1"># Measurement results</span>
    <span class="c1"># ==============================================================</span>

<div class="viewcode-block" id="PED4002.get_ber"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.get_ber">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_ber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current Bit Error Ratio.</span>
<span class="sd">        </span>
<span class="sd">        Returns NaN if not synced or valid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="c1"># Page 22: :FETC:ERAT?</span>
            <span class="n">val_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:FETC:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:ERAT?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mf">9e36</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>
        

<div class="viewcode-block" id="PED4002.get_error_count"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.get_error_count">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_error_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get total error count.&quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">d_node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="n">val_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:FETC:SENS</span><span class="si">{</span><span class="n">d_node</span><span class="si">}</span><span class="s1">:ECO?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mf">9e36</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="PED4002.get_bit_count"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.get_bit_count">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_bit_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get total bit count.&quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">c_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="c1"># Page 22: :FETCh:SENSe[2|4]:BCOunt? (Associated with clock node)</span>
            <span class="n">val_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:FETC:SENS</span><span class="si">{</span><span class="n">c_node</span><span class="si">}</span><span class="s1">:BCO?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mf">9e36</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>
        

<div class="viewcode-block" id="PED4002.get_frequency"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.get_frequency">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Queries the frequency measured at the clock input. </span>
<span class="sd">        </span>
<span class="sd">        This value is valid only if the error detector is synchronized. The return value is in Hz.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHs</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">c_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="c1"># Page 37: :SENSe[2|4]:FREQuency?</span>
            <span class="n">val_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;:SENS</span><span class="si">{</span><span class="n">c_node</span><span class="si">}</span><span class="s1">:FREQ?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mf">9e36</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>
        
       

    <span class="c1"># ==============================================================</span>
    <span class="c1"># Convenience configuration callable</span>
    <span class="c1"># ==============================================================</span>
    
<div class="viewcode-block" id="PED4002.setup"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.setup">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">patt_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;PRBS&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">patt_len</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">prbs</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">31</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">eye_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">center_delay</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">center_offset</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">offset_mV</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">delay_ps</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sync_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sync</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">run</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">stop</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">CHs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure the PED with the specified parameters in a sequential and logical order.</span>

<span class="sd">        This method allows setting up the physical layer (alignment), the logical layer (pattern/sync), </span>
<span class="sd">        and the measurement state (run/stop) in a single function call.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        patt_type : :obj:`str` {&#39;DATA&#39;, &#39;PRBS&#39;}, optional</span>
<span class="sd">            Pattern type expected by the error detector.</span>
<span class="sd">        patt_len : :obj:`int`, optional</span>
<span class="sd">            Length of the pattern (only relevant if ``patt_type=&#39;DATA&#39;``).</span>
<span class="sd">        prbs : :obj:`int`, optional</span>
<span class="sd">            Polynomial order for PRBS patterns (e.g., 7, 15, 31). Only used if ``patt_type=&#39;PRBS&#39;``.</span>
<span class="sd">        data : :obj:`str` or :obj:`np.ndarray`, optional</span>
<span class="sd">            Binary data sequence to be programmed into memory. Only used if ``patt_type=&#39;DATA&#39;``.</span>
<span class="sd">        eye_threshold : :obj:`float`, optional</span>
<span class="sd">            BER threshold used during the auto-alignment process (``center_delay`` / ``center_offset``) </span>
<span class="sd">            to detect the edges of the eye. Default is usually 1e-3.</span>
<span class="sd">        center_delay : :obj:`bool`, optional</span>
<span class="sd">            If True, initiates the **Auto-Align Clock Delay** process. The instrument scans the horizontal </span>
<span class="sd">            axis to find the center of the data eye (optimal sampling time).</span>
<span class="sd">        center_offset : :obj:`bool`, optional</span>
<span class="sd">            If True, initiates the **Auto-Align Voltage Offset** process. The instrument scans the vertical </span>
<span class="sd">            axis to find the center of the data eye (optimal sampling voltage).</span>
<span class="sd">        offset_mV : :obj:`float`, optional</span>
<span class="sd">            Manually sets the decision threshold voltage offset in millivolts (-300 to +300 mV).</span>
<span class="sd">        delay_ps : :obj:`float`, optional</span>
<span class="sd">            Manually sets the clock-to-data delay in picoseconds (-50 to +50 ps).</span>
<span class="sd">        sync_threshold : :obj:`float`, optional</span>
<span class="sd">            BER threshold below which the instrument considers the pattern **Synchronized**. </span>
<span class="sd">            Range: 1e-8 to 1e-1.</span>
<span class="sd">        sync : :obj:`bool`, optional</span>
<span class="sd">            If True, executes the **Pattern Synchronization** process. The PED shifts its internal </span>
<span class="sd">            reference pattern to match the incoming bit stream.</span>
<span class="sd">        run : :obj:`bool`, optional</span>
<span class="sd">            If True, enables the error counting gate (Start Measurement). Requires successful synchronization.</span>
<span class="sd">        stop : :obj:`bool`, optional</span>
<span class="sd">            If True, disables the error counting gate (Stop Measurement).</span>
<span class="sd">        CHs : :obj:`int` or :obj:`list[int]`, optional</span>
<span class="sd">            Specific channels to configure. If None, applies to all channels.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        **Difference between Alignment and Synchronization:**</span>
<span class="sd">        </span>
<span class="sd">        To measure BER correctly, the PED must perform two distinct operations:</span>

<span class="sd">        1.  **Alignment (Physical Layer - ``center_delay``, ``center_offset``)**: </span>

<span class="sd">            The instrument adjusts the sampling point (time and voltage) to position it in the center </span>
<span class="sd">            of the &quot;Eye Diagram&quot;. </span>

<span class="sd">            *   Without alignment, the PED samples noise or signal edges, resulting in a BER ~0.5.</span>
<span class="sd">            *   This process is analog and optimizes the signal quality reading.</span>

<span class="sd">        2.  **Synchronization (Logical Layer - ``sync``)**: </span>

<span class="sd">            The instrument shifts the bits of its internal reference pattern to match the sequence of the incoming data stream.</span>

<span class="sd">            *   This happens **after** alignment. If the signal is not aligned (sampling noise), synchronization will fail.</span>
<span class="sd">            *   Successful sync forces the BER to 0 (or very low values) assuming the link is healthy.</span>

<span class="sd">        **Execution Order:**</span>

<span class="sd">        When multiple parameters are passed, this method executes them in the following order to ensure stability:</span>

<span class="sd">        1. Pattern Configuration (Type, PRBS/Data)</span>
<span class="sd">        2. Alignment Thresholds (Eye Threshold)</span>
<span class="sd">        3. Physical Alignment (Center Delay -&gt; Center Offset -&gt; Manual Values)</span>
<span class="sd">        4. Synchronization Configuration (Sync Threshold, Type)</span>
<span class="sd">        5. Execution of Synchronization (Sync)</span>
<span class="sd">        6. Gating (Run/Stop)</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Full setup sequence: Configure PRBS31, align the eye, sync the pattern, and start measuring.</span>

<span class="sd">        &gt;&gt;&gt; ped = PED4002(&#39;USB0::...&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ped(patt_type=&#39;PRBS&#39;, </span>
<span class="sd">        ...     prbs=31, </span>
<span class="sd">        ...     center_delay=True,   # Find horizontal eye center</span>
<span class="sd">        ...     center_offset=True,  # Find vertical eye center</span>
<span class="sd">        ...     sync=True,           # Lock pattern</span>
<span class="sd">        ...     run=True)            # Start counting errors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_channels</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>

        <span class="c1"># 1. Pattern Configuration</span>
        <span class="k">if</span> <span class="n">patt_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patt_type</span><span class="p">(</span><span class="n">patt_type</span><span class="p">,</span> <span class="n">CHs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">patt_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patt_len</span><span class="p">(</span><span class="n">patt_len</span><span class="p">,</span> <span class="n">CHs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prbs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prbs</span><span class="p">(</span><span class="n">prbs</span><span class="p">,</span> <span class="n">CHs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">start_addr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">CHs</span><span class="o">=</span><span class="n">CHs</span><span class="p">)</span>

        <span class="c1"># 2. Alignment / Physical Layer</span>
        <span class="k">if</span> <span class="n">eye_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eye_threshold</span><span class="p">(</span><span class="n">eye_threshold</span><span class="p">,</span> <span class="n">CHs</span><span class="p">)</span>
        
        <span class="c1"># Auto-alignment processes take time and change delay/offset values</span>
        <span class="k">if</span> <span class="n">center_delay</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">center_delay</span><span class="p">(</span><span class="n">CHs</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">center_offset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">center_offset</span><span class="p">(</span><span class="n">CHs</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Manual overrides (applied after auto-align if specified)</span>
        <span class="k">if</span> <span class="n">offset_mV</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">offset_mV</span><span class="p">,</span> <span class="n">CHs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">delay_ps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">delay_ps</span><span class="p">,</span> <span class="n">CHs</span><span class="p">)</span>

        <span class="c1"># 3. Synchronization / Logical Layer</span>
        <span class="k">if</span> <span class="n">sync_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sync_threshold</span><span class="p">(</span><span class="n">sync_threshold</span><span class="p">,</span> <span class="n">CHs</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">sync</span><span class="p">:</span>
            <span class="c1"># Sync requires a good physical signal (alignment) first</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sync</span><span class="p">(</span><span class="n">CHs</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 4. Measurement Gating</span>
        <span class="k">if</span> <span class="n">run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">CHs</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="bp">self</span></div>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># ==============================================================</span>
    <span class="c1"># Status summary</span>
    <span class="c1"># ==============================================================</span>

<div class="viewcode-block" id="PED4002.get_metadata"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.get_metadata">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve a summary of the current PED configuration for the specified channel as a dictionary.&quot;&quot;&quot;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;PATT_TYPE&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_patt_type</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;PATT_LEN&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_patt_len</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;PRBS&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prbs</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;EYE_THR&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eye_threshold</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;OFFSET&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_offset</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;V_EDGES&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_voltage_edges</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;DELAY&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_delay</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;T_EDGES&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_edges</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;SYNC_THR&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sync_threshold</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;IS_SYNC&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sync</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;IS_RUNNIG&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;BER&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ber</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;ERR_COUNT&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_error_count</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;BIT_COUNT&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bit_count</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;FREQUENCY&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_frequency</span><span class="p">(</span><span class="n">ch</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">metadata</span></div>

<div class="viewcode-block" id="PED4002.print_setup"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.PED4002.print_setup">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print a summary of the current PED configuration for the specified channel.&quot;&quot;&quot;</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=========== SETUP CH</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s2"> ===========&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">1</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=================================&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div></div>









<span class="kn">import</span><span class="w"> </span><span class="nn">serial</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<div class="viewcode-block" id="IDPhotonics"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.IDPhotonics">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">IDPhotonics</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Minimal SCPI driver for IDPhotonics lasers</span>

<span class="sd">    .. rubric:: Attributes</span>
<span class="sd">    .. autosummary::</span>

<span class="sd">        ~IDPhotonics.usb</span>
<span class="sd">        ~IDPhotonics.host</span>
<span class="sd">        ~IDPhotonics.port</span>
<span class="sd">        ~IDPhotonics.serial</span>
<span class="sd">        ~IDPhotonics.socket</span>

<span class="sd">    .. rubric:: Main methods</span>
<span class="sd">    .. autosummary::</span>

<span class="sd">        __init__</span>
<span class="sd">        wavelength</span>
<span class="sd">        get_wavelength</span>
<span class="sd">        power</span>
<span class="sd">        get_power</span>
<span class="sd">        fine_tune</span>
<span class="sd">        output</span>
<span class="sd">        close</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usb</span> <span class="o">=</span> <span class="kc">False</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use USB connection (True) or Ethernet (False).&quot;&quot;&quot;</span>
    <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;192.168.0.1&#39;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;IP address of the device.&quot;&quot;&quot;</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Port for socket or USB connection. If usb=True, this is the COM port number.&quot;&quot;&quot;</span>
    <span class="n">serial</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;PySerial object instance (if usb=True).&quot;&quot;&quot;</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Socket object instance (if usb=False).&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;192.168.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">usb</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usb</span> <span class="o">=</span> <span class="n">usb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">usb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="mi">115200</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="s1">&#39;*IDN?&#39;</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        sends a scpi command to device</span>
<span class="sd">        command: SCPI command string, refer to documentation for allowed commands and syntax</span>
<span class="sd">        verbose: verbosity setting. 1 for RX, 2 for RX and TX, no printing for any other setting</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TX: &#39;</span> <span class="o">+</span> <span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">usb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">while</span> <span class="n">reply</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">reply</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">while</span> <span class="n">reply</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">reply</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RX: &#39;</span> <span class="o">+</span> <span class="n">reply</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">reply</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
<div class="viewcode-block" id="IDPhotonics.close"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.IDPhotonics.close">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Close connection</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">usb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IDPhotonics: disconnected&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IDPhotonics.get_wavelength"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.IDPhotonics.get_wavelength">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_wavelength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        returns the current wavelength of the laser in nm, at the specified channel</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WAV? 1,1,</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="IDPhotonics.wavelength"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.IDPhotonics.wavelength">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">wavelength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">ch</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        sets the wavelength of the laser in nm, at the specified channel</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;wav:lim? 1,1,</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;,;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wavelength</span> <span class="o">&lt;</span> <span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">wavelength</span> <span class="o">&gt;</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wavelength </span><span class="si">{</span><span class="n">wavelength</span><span class="si">}</span><span class="s1"> out of range. Must be between </span><span class="si">{</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> nm&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WAV 1,1,</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">wavelength</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;bwai 1,1,</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="IDPhotonics.get_power"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.IDPhotonics.get_power">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        returns the current power of the laser in dBm, at the specified channel</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;POW? 1,1,</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="IDPhotonics.power"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.IDPhotonics.power">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">power</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">ch</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        sets the power of the laser in dBm, at the specified channel</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;lim? 1,1,</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">power</span> <span class="o">&lt;</span> <span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">power</span> <span class="o">&gt;</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Power </span><span class="si">{</span><span class="n">power</span><span class="si">}</span><span class="s1"> out of range. Must be between </span><span class="si">{</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> dBm&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;POW 1,1,</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">power</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;bwai 1,1,</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="IDPhotonics.fine_tune"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.IDPhotonics.fine_tune">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">fine_tune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">ch</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        fine tunes the laser frequency in GHz, at the specified channel</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Offset:LIMit? 1,1,</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Offset out of range. Must be between </span><span class="si">{</span><span class="o">-</span><span class="n">limit</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Offset 1,1,</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;bwai 1,1,</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="IDPhotonics.output"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.IDPhotonics.output">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span><span class="nb">bool</span><span class="p">,</span> <span class="n">ch</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Enables or disables the output of the laser at the specified channel. To enable all lasers use `ch=&#39;*&#39;`. This method wait until output power is stable. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;State 1,1,</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;bwai 1,1,</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ch</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;State? 1,1,</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)))</span> <span class="o">==</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;State? 1,1,*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">::</span><span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
                <span class="k">return</span> <span class="n">outputs</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">outputs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span></div>
            
<div class="viewcode-block" id="IDPhotonics.__call__"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.IDPhotonics.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">wavelength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">power</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">ch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Convenience method to set wavelength and power in a single call.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">wavelength</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wavelength</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">power</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    
<div class="viewcode-block" id="IDPhotonics.get_metadata"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.IDPhotonics.get_metadata">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve a summary of the current laser configuration for the specified channel as a dictionary.&quot;&quot;&quot;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;WAVELENGTH_NM&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wavelength</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span>
            <span class="s1">&#39;POWER_DBM&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_power</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">metadata</span></div>
    
<div class="viewcode-block" id="IDPhotonics.print_setup"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.IDPhotonics.print_setup">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print a summary of the current laser configuration for the specified channel.&quot;&quot;&quot;</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=========== SETUP CH</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s2"> ===========&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">1</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">15</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=================================&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div></div>




<div class="viewcode-block" id="LeCroy_WavExp100H"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.LeCroy_WavExp100H">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">LeCroy_WavExp100H</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LeCroy Wave Expert 100H - minimal, extensible VISA wrapper for Teledyne LeCroy MAUI/XStreamDSO scopes adquisition.</span>

<span class="sd">    .. rubric:: Attributes</span>
<span class="sd">    .. autosummary::</span>

<span class="sd">        ~PED4002.inst</span>

<span class="sd">    .. rubric:: Main methods</span>
<span class="sd">    .. autosummary::</span>

<span class="sd">        __init__</span>
<span class="sd">        run</span>
<span class="sd">        stop</span>
<span class="sd">        single</span>
<span class="sd">        autoset</span>
<span class="sd">        acquire_waveform</span>
<span class="sd">        close </span>

<span class="sd">    Basic workflow example</span>
<span class="sd">    ----------------------</span>
<span class="sd">    &gt;&gt;&gt; scope = LeCroy_WavExp100H(addr_ID)</span>
<span class="sd">    &gt;&gt;&gt; t, v = scope.acquire_waveform(ch=1)  </span>
<span class="sd">    &gt;&gt;&gt; scope.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr_ID</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">addr_ID</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="n">visa</span><span class="o">.</span><span class="n">ResourceManager</span><span class="p">()</span><span class="o">.</span><span class="n">open_resource</span><span class="p">(</span><span class="n">addr_ID</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">10000</span> <span class="c1"># timeout in milliseconds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">22</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;little&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="s1">&#39;*IDN?&#39;</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="c1"># -------------------------</span>
    <span class="c1"># Low-level wrappers</span>
    <span class="c1"># -------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">resp</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_wait_until_idle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ask the instrument to wait until it is idle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;&quot;&quot;vbs? &#39;return=app.WaitUntilIdle(</span><span class="si">{</span><span class="n">timeout_s</span><span class="si">}</span><span class="s2">)&#39; &quot;&quot;&quot;</span><span class="p">)</span>

    
    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># Configuration and Acquisition</span>
    <span class="c1"># ------------------------------------------------------</span>

<div class="viewcode-block" id="LeCroy_WavExp100H.stop"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.LeCroy_WavExp100H.stop">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop any ongoing acquisition.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;vbs &#39;app.acquisition.triggermode=&quot;Stopped&quot;&#39; &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_until_idle</span><span class="p">()</span></div>

<div class="viewcode-block" id="LeCroy_WavExp100H.run"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.LeCroy_WavExp100H.run">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run acquisition again&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;vbs &#39;app.acquisition.triggermode=&quot;Normal&quot;&#39;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_until_idle</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="LeCroy_WavExp100H.single"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.LeCroy_WavExp100H.single">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">single</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Arm the scope for a single acquisition.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;vbs &#39;app.acquisition.triggermode=&quot;Single&quot;&#39; &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_until_idle</span><span class="p">()</span></div>

<div class="viewcode-block" id="LeCroy_WavExp100H.autoset"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.LeCroy_WavExp100H.autoset">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">autoset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run AutoSetup on the oscilloscope (convenience wrapper).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;vbs &#39;app.AutoSetup&#39; &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_until_idle</span><span class="p">()</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_wavedesc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses the output string from scope.query(&#39;C#:INSPECT? WAVEDESC&#39;) into a dictionary.</span>

<span class="sd">        The string contains lines separated by &#39;\r\n&#39;, each with the format &#39;KEY : VALUE&#39;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ch : str</span>
<span class="sd">            LeCroy channel from which to obtain the description. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary with parsed keys and values from the waveform descriptor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:INSPECT? WAVEDESC&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39; : &#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; : &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">metadata</span>
        
    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># Waveform readout and parsing</span>
    <span class="c1"># ------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_IEEE488p2_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a LeCroy binary waveform block (#nXXXXXXXXX&lt;data&gt;).&quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No block header found&quot;</span><span class="p">)</span>
        <span class="n">n_digits</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">n_digits</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">n_digits</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">length</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desc</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract a numeric or string value from the waveform descriptor.&quot;&quot;&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">\s*[:=]\s*(.+)&quot;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; not found in descriptor&quot;</span><span class="p">)</span>

        <span class="n">raw_value</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">raw_value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">num</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">raw_value</span>


<div class="viewcode-block" id="LeCroy_WavExp100H.acquire_waveform"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.LeCroy_WavExp100H.acquire_waveform">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">acquire_waveform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sweeps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Acquire waveform data from the specified channel.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ch : str</span>
<span class="sd">            Channel to acquire from {&#39;C1-4&#39;, &#39;F1-8&#39;}.</span>
<span class="sd">        points : int, optional</span>
<span class="sd">            Number of points to acquire. If None, acquires all available points.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        t : np.ndarray</span>
<span class="sd">            Time array corresponding to the waveform samples.</span>
<span class="sd">        v : np.ndarray</span>
<span class="sd">            Voltage array of the acquired waveform.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sweeps</span><span class="p">):</span>
            <span class="c1"># ---- Set number of points to acquire ----</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WFSU SP,0,NP,</span><span class="si">{</span><span class="n">points</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">0</span><span class="si">}</span><span class="s1">,FP,0,SN,0&#39;</span><span class="p">)</span> 

            <span class="c1"># ---- Read waveform data ----</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">:WF? DAT1&#39;</span><span class="p">)</span>
            <span class="n">raw_bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">read_raw</span><span class="p">()</span>
            <span class="n">data_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_IEEE488p2_block</span><span class="p">(</span><span class="n">raw_bytes</span><span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">data_</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># ---- Data scaling ----</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_wavedesc</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

        <span class="n">VERT_GAIN</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">desc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;VERTICAL_GAIN&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">VERT_OFFSET</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">desc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;VERTICAL_OFFSET&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">HORIZ_INTERVAL</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">desc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HORIZ_INTERVAL&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="c1"># HORIZ_OFFSET = float(desc.get(&quot;HORIZ_OFFSET&quot;, 0))</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_</span><span class="p">)),</span> <span class="n">sweeps</span><span class="p">)</span> <span class="o">*</span> <span class="n">HORIZ_INTERVAL</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="n">VERT_GAIN</span> <span class="o">-</span> <span class="n">VERT_OFFSET</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span></div>
    
<div class="viewcode-block" id="LeCroy_WavExp100H.close"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.LeCroy_WavExp100H.close">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the connection to the instrument.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__del__</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LeCroy: disconnected&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="EXFO_FVA60B"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.EXFO_FVA60B">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">EXFO_FVA60B</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Driver for EXFO FVA-60B Variable Attenuator.</span>

<span class="sd">    .. rubric:: Main methods</span>
<span class="sd">    .. autosummary::</span>

<span class="sd">        __init__</span>
<span class="sd">        attenuation</span>
<span class="sd">        get_attenuation</span>
<span class="sd">        wavelength</span>
<span class="sd">        calibrate</span>
<span class="sd">        get_insertion_loss</span>
<span class="sd">        close</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="EXFO_FVA60B.__init__"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.EXFO_FVA60B.__init__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">11</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the connection with the EXFO FVA-60B attenuator.</span>
<span class="sd">        Configuration according to manual: 9600 baud, 8 bits, no parity, 1 stop bit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        port : str</span>
<span class="sd">            Serial port where the FVA-60B is connected (e.g., &#39;COM3&#39; or &#39;/dev/ttyUSB0&#39;).</span>
<span class="sd">        timeout : int, optional</span>
<span class="sd">            Timeout for reading in seconds. Default is 11 seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
            <span class="n">baudrate</span><span class="o">=</span><span class="mi">9600</span><span class="p">,</span>
            <span class="n">bytesize</span><span class="o">=</span><span class="n">serial</span><span class="o">.</span><span class="n">EIGHTBITS</span><span class="p">,</span>
            <span class="n">parity</span><span class="o">=</span><span class="n">serial</span><span class="o">.</span><span class="n">PARITY_NONE</span><span class="p">,</span>
            <span class="n">stopbits</span><span class="o">=</span><span class="n">serial</span><span class="o">.</span><span class="n">STOPBITS_ONE</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FVA60B connected to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a command with the required format &gt;CMD&lt; and reads the response.</span>
<span class="sd">        All commands start with &#39;&gt;&#39; and end with &#39;&lt;&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span> <span class="c1"># Clear input buffer</span>

        <span class="n">full_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&gt;</span><span class="si">{</span><span class="n">command_str</span><span class="si">}</span><span class="s2">&lt;&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">full_cmd</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;No response received from FVA-60B.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Command rejected by the device (Code 1)&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">resp</span>

<div class="viewcode-block" id="EXFO_FVA60B.get_attenuation"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.EXFO_FVA60B.get_attenuation">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_attenuation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the current attenuation. Command: &gt;?&lt;.</span>
<span class="sd">        Returns float with the value in dB.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="EXFO_FVA60B.attenuation"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.EXFO_FVA60B.attenuation">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">attenuation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the attenuation. Command: &gt;A-xx.xx&lt;.</span>
<span class="sd">        Note: The manual indicates that the value must be divisible by 0.05 dB.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate 0.05 step</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">db_value</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: The value must be divisible by 0.05 dB. Rounding...&quot;</span><span class="p">)</span>
            <span class="n">db_value</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">db_value</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span> <span class="o">/</span> <span class="mi">20</span>

        <span class="k">if</span> <span class="n">db_value</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="ow">or</span> <span class="n">db_value</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Attenuation value is out of allowed range (0.5 to 65 dB). Adjusting...&quot;</span><span class="p">)</span>
            <span class="n">db_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">db_value</span><span class="p">,</span> <span class="mi">70</span><span class="p">))</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;A-</span><span class="si">{</span><span class="n">db_value</span><span class="si">:</span><span class="s2">05.2f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="EXFO_FVA60B.wavelength"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.EXFO_FVA60B.wavelength">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">wavelength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the wavelength. Command: &gt;Lxxxx&lt;.</span>
<span class="sd">        According to the manual, the range is 1270 to 1330 nm with a 10 nm step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">wavelength</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1270</span><span class="p">,</span> <span class="mi">1331</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Wavelength must be between 1270 and 1330 nm with a 10 nm step. Adjusting...&quot;</span><span class="p">)</span>
            <span class="n">wavelength</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">wavelength</span> <span class="o">-</span> <span class="mi">1270</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">1270</span>
            <span class="n">wavelength</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1270</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="mi">1330</span><span class="p">))</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="EXFO_FVA60B.calibrate"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.EXFO_FVA60B.calibrate">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes calibration (zeroing). Command: &gt;C&lt;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calibrating... (this takes a few seconds)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    
<div class="viewcode-block" id="EXFO_FVA60B.get_insertion_loss"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.EXFO_FVA60B.get_insertion_loss">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_insertion_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the current insertion loss. Command: &gt;IL?&lt;.</span>
<span class="sd">        Returns float with the value in dB.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span></div>

<div class="viewcode-block" id="EXFO_FVA60B.close"><a class="viewcode-back" href="../../lab.html#opticomlib.lab.EXFO_FVA60B.close">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the connection to the instrument.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">is_open</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>

<span class="c1"># import struct</span>
<span class="c1"># from smbus2 import SMBus, i2c_msg</span>

<span class="c1"># class TDCMX:</span>
<span class="c1">#     # Default I2C device address</span>
<span class="c1">#     DEFAULT_ADDRESS = 0x60</span>
    
<span class="c1">#     # Basic Operation commands</span>
<span class="c1">#     CMD_GET_STATUS = 0x00</span>
<span class="c1">#     CMD_RESET = 0x28</span>
<span class="c1">#     CMD_SET_FREQUENCY = 0x2E</span>
<span class="c1">#     CMD_GET_FREQUENCY = 0x2F</span>
<span class="c1">#     CMD_SET_DISPERSION = 0x30</span>
<span class="c1">#     CMD_GET_DISPERSION = 0x31</span>
<span class="c1">#     CMD_ENABLE_DEVICE = 0x1E</span>
<span class="c1">#     CMD_DISABLE_DEVICE = 0x1F</span>

<span class="c1">#     # Nominal settings commands</span>
<span class="c1">#     CMD_SET_STRTUP_BYTE = 0x34</span>
<span class="c1">#     CMD_GET_STRTUP_BYTE = 0x35</span>
<span class="c1">#     CMD_SET_NOMINAL_SETTINGS = 0x36</span>
<span class="c1">#     CMD_GET_NOMINAL_SETTINGS = 0x37</span>

<span class="c1">#     # Tunning information commands</span>
<span class="c1">#     CMD_GET_CHANNEL_PLAN = 0x3B</span>

<span class="c1">#     # General Device Information commands</span>
<span class="c1">#     CMD_GET_VERSION = 0x0F</span>
<span class="c1">#     CMD_READ_MANUFACTURER_NAME = 0x0E</span>
<span class="c1">#     CMD_READ_MODEL_NUMBER = 0x27</span>
<span class="c1">#     CMD_READ_SERIAL_NUMBER = 0x29</span>
<span class="c1">#     CMD_READ_MANUFACTURER_DATE = 0x2B</span>

<span class="c1">#     # Communication commands</span>
<span class="c1">#     CMD_SET_I2C_ADDRESS = 0x42</span>

<span class="c1">#     def __init__(self, bus_id=1, address=DEFAULT_ADDRESS):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Inicializa el dispositivo.</span>
<span class="c1">#         :param bus_id: ID del bus I2C (usualmente 1 en Raspberry Pi).</span>
<span class="c1">#         :param address: Direccin I2C del dispositivo (0x60 por defecto).</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         self.bus = SMBus(bus_id)</span>
<span class="c1">#         self.address = address</span>

<span class="c1">#     @staticmethod</span>
<span class="c1">#     def bytes2str(info_bytes: list[bytes]) -&gt; str:</span>
<span class="c1">#         &quot;&quot;&quot;Convierte bytes de info del dispositivo a string ASCII.&quot;&quot;&quot;</span>
<span class="c1">#         info_str = bytes(info_bytes).split(b&#39;\x00&#39;)[0]</span>
<span class="c1">#         return info_str.decode(&#39;ascii&#39;)</span>
        
<span class="c1">#     @staticmethod</span>
<span class="c1">#     def bytes2float(data_bytes: bytes | list[bytes]) -&gt; float:</span>
<span class="c1">#         &quot;&quot;&quot;Convierte 4 bytes Big-Endian a float32.&quot;&quot;&quot;</span>
<span class="c1">#         return struct.unpack(&#39;&gt;f&#39;, bytes(data_bytes))[0]</span>
    
<span class="c1">#     @staticmethod</span>
<span class="c1">#     def float2bytes(value: float) -&gt; list[int]:</span>
<span class="c1">#         &quot;&quot;&quot;Convierte un float32 a 4 bytes Big-Endian.&quot;&quot;&quot;</span>
<span class="c1">#         return list(struct.pack(&#39;&gt;f&#39;, value))</span>
    
<span class="c1">#     @staticmethod</span>
<span class="c1">#     def bytes2int(data_bytes: bytes | list[bytes]) -&gt; int:</span>
<span class="c1">#         &quot;&quot;&quot;Convierte 4 bytes Big-Endian a uint32.&quot;&quot;&quot;</span>
<span class="c1">#         return struct.unpack(&#39;&gt;I&#39;, bytes(data_bytes))[0]</span>
    
<span class="c1">#     @staticmethod</span>
<span class="c1">#     def byte2int8(byte: bytes) -&gt; int:</span>
<span class="c1">#         &quot;&quot;&quot;Convierte 1 byte Big-Endian a uint8.&quot;&quot;&quot;</span>
<span class="c1">#         return struct.unpack(&#39;&gt;B&#39;, byte)[0]</span>

<span class="c1">#     def _parse_status(self, status_bytes: bytes | list[bytes]) -&gt; dict:</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Decodifica los 4 bytes de estatus y devuelve la info en formato de diccionario.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         value = self.bytes2int(status_bytes)</span>

<span class="c1">#         status = {}</span>
<span class="c1">#         status[&#39;BUSY_ERROR&#39;] = (value &gt;&gt; 23) &amp; 1</span>
<span class="c1">#         status[&#39;OVERRUN_ERROR&#39;] = (value &gt;&gt; 22) &amp; 1</span>
<span class="c1">#         status[&#39;COMMAND_ERROR&#39;] = (value &gt;&gt; 21) &amp; 1</span>
<span class="c1">#         status[&#39;TDCMX_ACTIVE&#39;] = (value &gt;&gt; 20) &amp; 1</span>
<span class="c1">#         status[&#39;TDCMX_READY&#39;] = (value &gt;&gt; 19) &amp; 1</span>
<span class="c1">#         status[&#39;EEPROM_ERROR&#39;] = (value &gt;&gt; 18) &amp; 1</span>

<span class="c1">#         status[&#39;TEC4_LIMIT_REACHED&#39;] = (value &gt;&gt; 7) &amp; 1</span>
<span class="c1">#         status[&#39;TEC3_LIMIT_REACHED&#39;] = (value &gt;&gt; 6) &amp; 1</span>
<span class="c1">#         status[&#39;TEC2_LIMIT_REACHED&#39;] = (value &gt;&gt; 5) &amp; 1</span>
<span class="c1">#         status[&#39;TEC1_LIMIT_REACHED&#39;] = (value &gt;&gt; 4) &amp; 1</span>

<span class="c1">#         status[&#39;TEC4_IN_RANGE&#39;] = (value &gt;&gt; 3) &amp; 1</span>
<span class="c1">#         status[&#39;TEC3_IN_RANGE&#39;] = (value &gt;&gt; 2) &amp; 1</span>
<span class="c1">#         status[&#39;TEC2_IN_RANGE&#39;] = (value &gt;&gt; 1) &amp; 1</span>
<span class="c1">#         status[&#39;TEC1_IN_RANGE&#39;] = value &amp; 1</span>

<span class="c1">#         return status</span>
          
<span class="c1">#     def _send_command(self, cmd_id: int, data: list[int]=[]):</span>
<span class="c1">#         &quot;&quot;&quot;Enva el comando y datos al dispositivo (Write Transaction).&quot;&quot;&quot;</span>
<span class="c1">#         try:</span>
<span class="c1">#             msg = i2c_msg.write(self.address, [cmd_id] + data)</span>
<span class="c1">#             self.bus.i2c_rdwr(msg)</span>
<span class="c1">#         except Exception as e:</span>
<span class="c1">#             print(f&quot;Error escribiendo comando I2C: {e}&quot;)</span>
<span class="c1">#             raise</span>

<span class="c1">#     def _read_response(self, n_bytes: int=0):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Implementa el protocolo de Polling descrito en la Pgina 12 (Figura 7).</span>
<span class="c1">#         Lee repetidamente los 4 bytes de estatus hasta que el bit &#39;Busy&#39; se limpie.</span>
<span class="c1">#         Luego lee la respuesta completa.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         max_retries = 100</span>
        
<span class="c1">#         for _ in range(max_retries):</span>
<span class="c1">#             # Leer solo los 4 bytes de estatus</span>
<span class="c1">#             msg_status = i2c_msg.read(self.address, length=4)</span>
<span class="c1">#             self.bus.i2c_rdwr(msg_status)</span>
<span class="c1">#             status_bytes = list(msg_status)</span>
            
<span class="c1">#             status = self._parse_status(status_bytes)</span>
            
<span class="c1">#             if status[&#39;COMMAND_ERROR&#39;]:</span>
<span class="c1">#                 raise RuntimeError(&quot;El dispositivo TDCMX report un Command Error.&quot;)</span>
            
<span class="c1">#             if status[&#39;OVERRUN_ERROR&#39;]:</span>
<span class="c1">#                 raise RuntimeError(&quot;El dispositivo TDCMX report un Overrun Error.&quot;)</span>
            
<span class="c1">#             if status[&#39;EEPROM_ERROR&#39;]:</span>
<span class="c1">#                 raise RuntimeError(&quot;El dispositivo TDCMX report un EEPROM Error.&quot;)</span>

<span class="c1">#             if not status[&#39;BUSY_ERROR&#39;]:</span>
<span class="c1">#                 # Si no hay datos extra que leer (solo queramos saber que termin)</span>
<span class="c1">#                 if n_bytes == 0:</span>
<span class="c1">#                     return status</span>
                
<span class="c1">#                 # Si hay datos, hacemos la lectura final completa (Status 4 bytes + Data N bytes)</span>
<span class="c1">#                 # Pgina 12: &quot;reading the full device answer (4 status bytes + N data bytes)&quot;</span>
<span class="c1">#                 total_length = 4 + n_bytes</span>
<span class="c1">#                 msg_full = i2c_msg.read(self.address, total_length)</span>
<span class="c1">#                 self.bus.i2c_rdwr(msg_full)</span>
<span class="c1">#                 response = list(msg_full)</span>

<span class="c1">#                 status = self._parse_status(response[:4])</span>
                
<span class="c1">#                 # Retornamos el estatus y la parte de datos (bytes 4 en adelante)</span>
<span class="c1">#                 return status, response[4:]</span>
            
<span class="c1">#             # Esperar un poco antes de volver a consultar (10ms es el tiempo tpico de proceso segn PDF)</span>
<span class="c1">#             time.sleep(0.01)</span>
            
<span class="c1">#         raise TimeoutError(&quot;El dispositivo TDCMX permaneci ocupado (Busy) demasiado tiempo.&quot;)</span>
    
<span class="c1">#     def _query(self, cmd_id: int, data: list[int]=[], n_bytes: int=0):</span>
<span class="c1">#         &quot;&quot;&quot;Enva un comando y lee la respuesta.&quot;&quot;&quot;</span>
<span class="c1">#         self._send_command(cmd_id, data)</span>
<span class="c1">#         return self._read_response(n_bytes)</span>

<span class="c1">#     # ------------------------------------------------------</span>
<span class="c1">#     # Comandos principales</span>

<span class="c1">#     def get_status(self):</span>
<span class="c1">#         &quot;&quot;&quot;Obtiene el estatus actual del dispositivo.&quot;&quot;&quot;</span>
<span class="c1">#         status = self._query(self.CMD_GET_STATUS)</span>
<span class="c1">#         return self._parse_status(status[:4])</span>
    
<span class="c1">#     def reset(self):</span>
<span class="c1">#         &quot;&quot;&quot;Reinicio por software&quot;&quot;&quot;</span>
<span class="c1">#         self._send_command(self.CMD_RESET)</span>
<span class="c1">#         time.sleep(0.3) # Esperar 300ms segn PDF</span>

<span class="c1">#     def set_frequency(self, frequency_ghz):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Ajusta el Set Point de Frecuencia.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         status, freq = self._query(self.CMD_SET_FREQUENCY, self.float2bytes(frequency_ghz), n_bytes=4) </span>
<span class="c1">#         print(&#39;Frequency set response:&#39;, self.bytes2float(freq))</span>
<span class="c1">#         return status</span>

<span class="c1">#     def get_frequency(self):</span>
<span class="c1">#         &quot;&quot;&quot;Lee la frecuencia actual.&quot;&quot;&quot;</span>
<span class="c1">#         _, freq = self._query(self.CMD_GET_FREQUENCY, n_bytes=4)</span>
<span class="c1">#         return self.bytes2float(freq)</span>

<span class="c1">#     def set_dispersion(self, dispersion_ps_nm):</span>
<span class="c1">#         &quot;&quot;&quot;Ajusta la dispersin.&quot;&quot;&quot;</span>
<span class="c1">#         status, disp = self._query(self.CMD_SET_DISPERSION, self.float2bytes(dispersion_ps_nm), n_bytes=4)</span>
<span class="c1">#         print(&#39;Dispersion set response:&#39;, self.bytes2float(disp))</span>
<span class="c1">#         return status</span>

<span class="c1">#     def enable_device(self):</span>
<span class="c1">#         &quot;&quot;&quot;Activa el control TEC.&quot;&quot;&quot;</span>
<span class="c1">#         return self._query(self.CMD_ENABLE_DEVICE)</span>

<span class="c1">#     def disable_device(self):</span>
<span class="c1">#         &quot;&quot;&quot;Desactiva el control TEC (Cmd 0x1F).&quot;&quot;&quot;</span>
<span class="c1">#         return self._query(self.CMD_DISABLE_DEVICE)</span>

<span class="c1">#     def get_device_info(self):</span>
<span class="c1">#         &quot;&quot;&quot;Lee el nmero de serie (Cmd 0x29). Devuelve string.&quot;&quot;&quot;</span>
<span class="c1">#         _, version = self._send_command(self.CMD_GET_VERSION, n_bytes=2)</span>
<span class="c1">#         _, manufac_name = self._send_command(self.CMD_READ_MANUFACTURER_NAME, n_bytes=256)</span>
<span class="c1">#         _, model_number = self._send_command(self.CMD_READ_MODEL_NUMBER, n_bytes=256)</span>
<span class="c1">#         _, serial_number = self._send_command(self.CMD_READ_SERIAL_NUMBER, n_bytes=256)</span>
<span class="c1">#         _, manufac_date = self._send_command(self.CMD_READ_MANUFACTURER_DATE, n_bytes=256)</span>

<span class="c1">#         return &#39;, &#39;. join([</span>
<span class="c1">#             f&quot;v{self.byte2int8(version[0])}.{self.byte2int8(version[1])}&quot;,</span>
<span class="c1">#             self.bytes2str(manufac_name),</span>
<span class="c1">#             self.bytes2str(model_number),</span>
<span class="c1">#             self.bytes2str(serial_number),</span>
<span class="c1">#             self.bytes2str(manufac_date)</span>
<span class="c1">#         ])</span>
        

        

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Ing. Armando P. Romeu.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>